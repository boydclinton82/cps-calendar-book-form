---
phase: 09-functional-documentation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/09-functional-documentation/BOOKING-FLOW.md
autonomous: true

must_haves:
  truths:
    - "Complete booking creation flow documented step-by-step from slot click to booking confirmation"
    - "Complete booking edit flow documented from booking click through user/duration change to close"
    - "Booking deletion flow documented with immediate removal behavior"
    - "All decision points have decision tables with exhaustive condition-outcome rows"
    - "Booking panel state machine documented with all states and transitions"
    - "Booking popup state machine documented with all states and transitions"
  artifacts:
    - path: ".planning/phases/09-functional-documentation/BOOKING-FLOW.md"
      provides: "Complete booking lifecycle specification"
      min_lines: 400
      contains: "Decision point"
  key_links:
    - from: "BOOKING-FLOW.md"
      to: "DATA-STORAGE.md"
      via: "Data structure references"
      pattern: "dateKey.*timeKey|YYYY-MM-DD.*HH:00"
    - from: "BOOKING-FLOW.md"
      to: "API-CONTRACTS.md"
      via: "API operation references"
      pattern: "POST.*bookings|PUT.*update|DELETE"
    - from: "BOOKING-FLOW.md"
      to: "STATE-MANAGEMENT.md"
      via: "Optimistic update pattern references"
      pattern: "optimistic|rollback|triggerSync"
---

<objective>
Create BOOKING-FLOW.md documenting the complete booking lifecycle as a technology-neutral functional specification.

Purpose: FUNC-01 requires the complete booking flow documented step-by-step with all decision points and branching logic. This is the largest and most important functional spec -- it covers the entire user journey from clicking a slot to creating, editing, and deleting bookings. A Rails developer must be able to implement the exact same interactive behavior from this document alone.

Output: .planning/phases/09-functional-documentation/BOOKING-FLOW.md
</objective>

<execution_context>
@/Users/clintonweekes/.claude/get-shit-done/workflows/execute-plan.md
@/Users/clintonweekes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-functional-documentation/09-RESEARCH.md
@.planning/phases/06-code-extraction/FILE-MANIFEST.md
@.planning/phases/08-architecture-documentation/DATA-STORAGE.md
@.planning/phases/08-architecture-documentation/API-CONTRACTS.md
@.planning/phases/08-architecture-documentation/STATE-MANAGEMENT.md
@.planning/phases/06-code-extraction/extracted-code/src/App.jsx
@.planning/phases/06-code-extraction/extracted-code/src/hooks/useBookings.js
@.planning/phases/06-code-extraction/extracted-code/src/hooks/useKeyboard.js
@.planning/phases/06-code-extraction/extracted-code/src/components/BookingPanel.jsx
@.planning/phases/06-code-extraction/extracted-code/src/components/BookingPopup.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BOOKING-FLOW.md (FUNC-01)</name>
  <files>.planning/phases/09-functional-documentation/BOOKING-FLOW.md</files>
  <action>
Create a comprehensive functional specification for the complete booking lifecycle. Read the source files listed in context to extract exact behavior. Use the hybrid approach from 09-RESEARCH.md: workflow narratives for linear flows, decision tables for conditional logic, state machines for UI state transitions, and Given-When-Then scenarios for testable edge cases.

**Document structure (sections):**

1. **Overview** - What this document covers, relationship to other spec docs

2. **Application Modes** - Three mutually exclusive interaction modes:
   - NAVIGATION MODE: No slot or booking selected, user can browse dates, toggle views, use arrow keys
   - PANEL MODE: Slot selected, booking panel open, user picks person then duration
   - POPUP MODE: Existing booking selected, popup open for editing/deleting
   - Include state transition table: which events move between modes
   - Critical rule: Only one mode active at a time

3. **Booking Creation Flow** (step-by-step workflow):
   - Step 1: Slot Selection - User clicks available slot OR presses Enter on focused slot
     - Decision table: What happens based on slot status (available/booked/blocked/past)
     - Include: dateKey and slot object are captured at selection time
   - Step 2: User Selection - Panel shows user buttons from config
     - Each button shows user name + keyboard shortcut letter
     - Clicking or pressing hotkey selects user
     - Selected user is visually highlighted
   - Step 3: Duration Selection - Panel shows 1hr/2hr/3hr buttons
     - Decision table: Which durations are enabled/disabled based on:
       - Slot hour + duration exceeding END_HOUR (22)
       - Conflict with existing bookings in the duration range
     - canBook() validation logic: checks ALL slots from startHour to startHour+duration-1
     - Selecting duration immediately creates booking (no submit button)
   - Step 4: Booking Confirmation
     - Optimistic update: local state updated immediately
     - API call in background (POST /api/bookings)
     - Panel closes, slot/user selection cleared
     - On API failure: triggerSync to rollback from server truth
   - Cancel: ESC key or Cancel button closes panel, clears selection

4. **Booking Edit Flow** (step-by-step workflow):
   - Step 1: Booking Click - User clicks existing booking block in day view or week view
     - Opens popup modal with booking details
     - Captures: dateKey, timeKey, hour, current user, current duration
   - Step 2: Inline User Change
     - Click different user button or press user hotkey
     - Immediate optimistic update (no save button)
     - API call: PUT /api/bookings/update with { user: newUser }
   - Step 3: Inline Duration Change
     - Decision table: Which durations are enabled/disabled
     - canChangeDuration() logic: only checks NEW slots beyond current duration
     - Duration shrink always allowed, extension checks for conflicts
     - Immediate optimistic update
     - API call: PUT /api/bookings/update with { duration: newDuration }
   - Step 4: Close Popup
     - ESC key, Enter key, click X button, or click backdrop
     - All changes already saved (optimistic), closing just dismisses UI

5. **Booking Deletion Flow**:
   - From popup: Press D key or click Delete button
   - Immediate optimistic removal from local state
   - Empty date cleanup (if last booking on that date, remove date key)
   - API call: DELETE /api/bookings/update
   - Popup closes immediately
   - On API failure: triggerSync to restore from server

6. **Booking Panel State Machine**:
   - States: CLOSED, AWAITING_USER, AWAITING_DURATION
   - Full transition table with From State, Event, To State, Side Effects
   - Include all transitions: slot click, user select, duration select, cancel, ESC

7. **Booking Popup State Machine**:
   - States: CLOSED, VIEWING (showing booking, can edit inline)
   - Transitions: booking click opens, close/delete returns to CLOSED
   - Keyboard trap: All navigation shortcuts disabled while popup open

8. **Keyboard Shortcuts in Booking Context**:
   - Table showing which shortcuts are active in each mode
   - Dynamic user hotkeys (from config, not hardcoded)
   - Duration hotkeys (1, 2, 3) - conditional on validity

9. **Conflict Detection Logic**:
   - canBook(): Check ALL slots in duration range for conflicts
   - canChangeDuration(): Only check NEW slots beyond current duration, exclude blocks caused by the booking being edited
   - Decision table with examples showing pass/fail scenarios

10. **Given-When-Then Scenarios** for key behaviors:
    - Create 1-hour booking (happy path)
    - Create 3-hour booking with conflict at hour 2
    - Edit booking user (happy path)
    - Extend booking duration successfully
    - Extend booking duration blocked by adjacent booking
    - Delete booking
    - Cancel mid-flow (after user selected, before duration)
    - Keyboard-only booking creation
    - Popup keyboard trap (W key ignored while popup open)

**Writing rules:**
- Technology-neutral language: "System" not "Component", "User" not "onClick"
- Describe outcomes, not mechanisms: "booking appears in calendar" not "state re-renders"
- Include "Because" explanations for non-obvious behavior
- Reference source files for implementation context (e.g., "See useBookings.js lines 77-104")
- Use markdown tables for all decision logic
- Minimum 400 lines
  </action>
  <verify>
Verify the document exists and covers all required sections:
- File exists at .planning/phases/09-functional-documentation/BOOKING-FLOW.md
- Contains "Application Modes" section with 3 modes
- Contains "Booking Creation Flow" with at least 4 steps
- Contains "Booking Edit Flow" with inline editing
- Contains "Booking Deletion Flow"
- Contains state machine tables for both panel and popup
- Contains "Conflict Detection" section with canBook and canChangeDuration logic
- Contains at least 8 Given-When-Then scenarios
- Contains decision tables (markdown tables with conditions and outcomes)
- No React-specific terminology in main content (no useState, useCallback, hooks, props, render)
- Minimum 400 lines
  </verify>
  <done>
BOOKING-FLOW.md exists with complete booking lifecycle specification covering creation, editing, and deletion flows with decision tables, state machines, conflict detection logic, and Given-When-Then scenarios. No React terminology in behavior descriptions.
  </done>
</task>

</tasks>

<verification>
1. File exists: `ls -la .planning/phases/09-functional-documentation/BOOKING-FLOW.md`
2. Line count: `wc -l .planning/phases/09-functional-documentation/BOOKING-FLOW.md` (expect 400+)
3. Sections present: grep for "Application Modes", "Booking Creation Flow", "Booking Edit Flow", "Booking Deletion", "State Machine", "Conflict Detection", "Given.*When.*Then"
4. No React terms: grep -i "useState\|useCallback\|useEffect\|props\|hook\|render\|component" should return 0 matches in main content (only in source file references)
5. Decision tables present: grep for "|.*|.*|" pattern (markdown tables)
6. Cross-references to architecture docs: grep for "DATA-STORAGE\|API-CONTRACTS\|STATE-MANAGEMENT"
</verification>

<success_criteria>
- BOOKING-FLOW.md is a complete, self-contained functional specification
- A Rails developer can implement the exact booking flow from this document
- All 3 interaction modes documented with state transitions
- Every decision point has a decision table (not prose)
- Conflict detection logic is explicit with worked examples
- Keyboard shortcuts documented per-mode
- At least 8 Given-When-Then scenarios cover key behaviors
- Technology-neutral language throughout
</success_criteria>

<output>
After completion, create `.planning/phases/09-functional-documentation/09-01-SUMMARY.md`
</output>
