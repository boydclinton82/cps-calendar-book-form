---
phase: 09-functional-documentation
plan: 03
type: execute
wave: 2
depends_on: ["09-01", "09-02"]
files_modified:
  - .planning/phases/09-functional-documentation/TIME-DATE-HANDLING.md
  - .planning/phases/09-functional-documentation/EDGE-CASES.md
autonomous: true

must_haves:
  truths:
    - "QLD timezone storage rationale documented with IANA references"
    - "Slot calculation logic documented (generateTimeSlots, isSlotPast, isSlotBlocked)"
    - "Current hour logic documented with end-of-hour boundary rule"
    - "Week navigation documented with Monday-start, 7-day navigation"
    - "All edge cases cataloged with exact expected behavior (not vague 'handle gracefully')"
    - "Booking conflicts documented with concrete multi-user scenarios"
    - "Midnight boundary and operating hour limits documented"
  artifacts:
    - path: ".planning/phases/09-functional-documentation/TIME-DATE-HANDLING.md"
      provides: "Time and date logic specification"
      min_lines: 200
      contains: "Slot"
    - path: ".planning/phases/09-functional-documentation/EDGE-CASES.md"
      provides: "Comprehensive edge case catalog"
      min_lines: 300
      contains: "Edge Case"
  key_links:
    - from: "EDGE-CASES.md"
      to: "BOOKING-FLOW.md"
      via: "Edge cases reference booking flow"
      pattern: "BOOKING-FLOW|booking creation|booking edit"
    - from: "EDGE-CASES.md"
      to: "BOOK-NOW-FEATURE.md"
      via: "Edge cases reference Book Now"
      pattern: "BOOK-NOW|Book Now"
    - from: "EDGE-CASES.md"
      to: "TIMEZONE-TOGGLE.md"
      via: "Edge cases reference timezone"
      pattern: "TIMEZONE|DST|NSW"
    - from: "TIME-DATE-HANDLING.md"
      to: "DATA-STORAGE.md"
      via: "Storage format references"
      pattern: "YYYY-MM-DD|HH:00|dateKey|timeKey"
---

<objective>
Create TIME-DATE-HANDLING.md and EDGE-CASES.md completing the Phase 9 functional documentation set.

Purpose: FUNC-05 (time/date handling) covers the foundational logic that all features depend on -- how slots are generated, how "past" is determined, how weeks are calculated. FUNC-04 (edge cases) is the comprehensive catalog ensuring no "what if" gaps remain. These docs reference the booking flow, Book Now, and timezone specs from Plans 01-02.

Output:
- .planning/phases/09-functional-documentation/TIME-DATE-HANDLING.md
- .planning/phases/09-functional-documentation/EDGE-CASES.md
</objective>

<execution_context>
@/Users/clintonweekes/.claude/get-shit-done/workflows/execute-plan.md
@/Users/clintonweekes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-functional-documentation/09-RESEARCH.md
@.planning/phases/09-functional-documentation/09-01-SUMMARY.md
@.planning/phases/09-functional-documentation/09-02-SUMMARY.md
@.planning/phases/06-code-extraction/FILE-MANIFEST.md
@.planning/phases/08-architecture-documentation/DATA-STORAGE.md
@.planning/phases/08-architecture-documentation/POLLING-SYNC.md
@.planning/phases/08-architecture-documentation/STATE-MANAGEMENT.md
@.planning/phases/06-code-extraction/extracted-code/src/utils/time.js
@.planning/phases/06-code-extraction/extracted-code/src/hooks/useBookings.js
@.planning/phases/06-code-extraction/extracted-code/src/App.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TIME-DATE-HANDLING.md (FUNC-05)</name>
  <files>.planning/phases/09-functional-documentation/TIME-DATE-HANDLING.md</files>
  <action>
Create a functional specification for all time and date logic in the booking system. Read time.js thoroughly for exact behavior and App.jsx for how time utilities are used.

**Document structure:**

1. **Overview**
   - All time logic in one place: slot generation, date formatting, past detection, timezone display, week navigation
   - Storage timezone: Queensland (Australia/Brisbane, AEST, UTC+10, no DST)
   - Why QLD: Business operates in QLD, no DST simplifies storage, NSW conversion is display-only

2. **Operating Hours**
   - START_HOUR: 6 (6:00 AM)
   - END_HOUR: 22 (10:00 PM)
   - Total bookable slots per day: 16 (hours 6 through 21 inclusive)
   - These are constants, not configurable per instance
   - Because: All instances share the same operating hours

3. **Time Slot Generation**
   - System generates 16 slots: one per hour from START_HOUR to END_HOUR-1
   - Each slot has:
     - hour (integer 6-21): The hour in 24-hour format
     - time (string): Human-readable 12-hour format (e.g., "6:00 AM", "2:00 PM")
     - key (string): Storage format HH:00 with leading zero (e.g., "06:00", "14:00")
   - Slots are generated once at app initialization (static list)
   - Table showing all 16 slots with their hour, time, and key values

4. **Date Formatting**
   - Storage format (dateKey): YYYY-MM-DD (e.g., "2026-02-14")
     - Used in API requests, storage keys, booking lookups
     - Generated from ISO string date portion
   - Display format (long): "Wednesday, February 14, 2026"
     - Used in header for current date
   - Display format (short): "Wed, Feb 14"
     - Used in week view day headers
   - Decision table: Which format is used where

5. **Current Hour and isSlotPast Logic** (critical):
   - Rule: A slot is past ONLY when the NEXT hour begins
   - Implementation: Compare current time to END of slot (hour + 1, minute 0, second 0)
   - At 9:01 AM: 9:00 AM slot is NOT past (hour hasn't ended)
   - At 9:59 AM: 9:00 AM slot is NOT past (hour hasn't ended)
   - At 10:00 AM: 9:00 AM slot IS past (next hour has begun)
   - Because: Users should be able to book "right now" even if 45 minutes have passed
   - Decision table showing isSlotPast at various times

6. **Today's View vs Future Date View**
   - Today: Only show slots that are NOT past (filter out elapsed hours)
   - Future dates: Show ALL 16 slots
   - Past dates: Show ALL 16 slots (all will be "past" status)
   - Because: Today's view is action-oriented (what can I book NOW), other dates are informational

7. **Hourly Refresh Mechanism**
   - System automatically re-evaluates slot visibility when the hour changes
   - Precision: Fires exactly at HH:00:00.000 (calculates milliseconds until next hour)
   - Effect: Past slots disappear from today's view at the turn of each hour
   - Example: At 9:59:59, 9 AM slot visible. At 10:00:00, 9 AM slot removed from today's view.
   - Because: Without this, users would see stale slot availability until they refresh the page

8. **Multi-Hour Booking Slot Logic**
   - isSlotBlocked: Checks if an hour falls WITHIN another booking's range
   - Booking at hour H with duration D occupies hours H through H+D-1
   - Hour H itself: status "booked" (direct booking)
   - Hours H+1 through H+D-1: status "blocked" (blocked by booking at H)
   - Hour H+D: NOT blocked (first free hour after booking)
   - Worked example with booking at 09:00, duration 3:
     - 09:00 = "booked", 10:00 = "blocked", 11:00 = "blocked", 12:00 = "available"

9. **Week Navigation**
   - Week always starts on Monday
   - getStartOfWeek: Find Monday of the week containing a date
     - Sunday (day 0): Go back 6 days to Monday
     - Monday (day 1): Stay at current date
     - Tuesday-Saturday: Go back to Monday
   - Navigation in week view: Left/Right arrows move by 7 days
   - Navigation in day view: Left/Right arrows move by 1 day
   - getWeekDays: Returns 7 consecutive dates starting from given date
   - Because: Consistent Monday-start week matches Australian business convention

10. **Date Arithmetic**
    - addDays: Returns new date object, does NOT mutate input
    - Handles negative values for subtraction
    - Used for day navigation and week generation

11. **Timezone Display Offset** (cross-reference to TIMEZONE-TOGGLE.md):
    - formatHour with useNSWTime flag
    - When true AND NSW in DST: displayed hour = stored hour + 1
    - Affects display only, not storage or calculations
    - 12-hour formatting: handles AM/PM, midnight (0 = 12 AM), noon (12 = 12 PM)

**Writing rules:**
- Technology-neutral: "System generates" not "function returns"
- Include worked examples with concrete times and dates
- Reference time.js for implementation detail
- Minimum 200 lines
  </action>
  <verify>
Verify TIME-DATE-HANDLING.md:
- File exists with 200+ lines
- Contains operating hours (6-22) and slot count (16)
- Contains isSlotPast logic with the "end of hour" rule
- Contains multi-hour blocking logic with worked example
- Contains week navigation with Monday-start rule
- Contains date format reference table
- Contains hourly refresh mechanism
- No React terminology in main content
  </verify>
  <done>
TIME-DATE-HANDLING.md exists with complete specification of slot generation, past detection, multi-hour blocking, week navigation, date formatting, and hourly refresh for the booking system.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create EDGE-CASES.md (FUNC-04)</name>
  <files>.planning/phases/09-functional-documentation/EDGE-CASES.md</files>
  <action>
Create a comprehensive edge case catalog covering ALL boundary conditions, failure modes, and unexpected scenarios across the entire booking system. Read ALL source files to find edge cases documented in code comments (look for EDGE_CASE annotations). Also reference Plans 01-02 summaries for edge cases already identified.

**Document structure:**

1. **Overview**
   - Purpose: Exhaustive catalog of "what if" scenarios
   - Format: Each edge case has What Happens, Expected Behavior, Why This Works, Warning Signs
   - Organized by category (not by feature) for implementer reference

2. **Category: Booking Conflicts**
   - EC-01: Two users book same slot simultaneously (optimistic updates)
     - User A books 09:00 locally. Before API confirms, User B books 09:00.
     - Server accepts first writer (last-write-wins at server level)
     - Losing user's optimistic update replaced by polling (within 7 seconds)
     - Warning: Booking may appear then disappear (correct behavior, not a bug)
   - EC-02: User extends duration into occupied slot
     - Booking at 09:00 for 1 hour, tries to extend to 3 hours, but 11:00 is booked
     - Duration button for 3 hours is disabled
     - canChangeDuration only checks slots beyond current duration
   - EC-03: Adjacent booking prevents extension
     - Booking at 09:00 for 2 hours, adjacent booking at 11:00
     - 3-hour duration disabled (would conflict at 11:00)
     - 2-hour duration already active, 1-hour shrink always allowed
   - EC-04: Multi-hour booking creates multiple blocked slots
     - Booking at 07:00 for 3 hours blocks 08:00 and 09:00
     - Blocked slots are non-interactive (can't click, can't book)
     - Booking popup opens for the START slot (07:00), not blocked slots

3. **Category: Past Hours and Current Hour**
   - EC-05: Booking current hour at 59 minutes past
     - At 9:59 AM, 9:00 AM slot is still available and bookable
     - isSlotPast checks END of hour (10:00), not start
   - EC-06: Hour transition while viewing today
     - At 10:00 AM, the 9:00 AM slot disappears from today's view
     - Hourly refresh triggers automatic re-evaluation
     - Any booking panel open for 9:00 AM should close (slot no longer valid)
   - EC-07: Booking past slots on future dates
     - On tomorrow's calendar, 6:00 AM slot is available even though it's "past" relative to today
     - isSlotPast only applies to today's date
   - EC-08: Book Now at hour boundary
     - At exactly 10:00:00 AM, Book Now should evaluate for 10:00 AM slot, not 9:00 AM
     - Current hour = now.getHours() returns 10 at 10:00:00

4. **Category: Multi-Hour Bookings**
   - EC-09: Duration limited by end of operating hours
     - Booking at 21:00 (9 PM): Only 1-hour duration available (22:00 is end)
     - Booking at 20:00 (8 PM): 1-hour and 2-hour available (3 hours would hit 23:00)
     - Decision table: slot hour + duration must not exceed END_HOUR (22)

     | Slot Hour | Max Duration | Reason |
     | 6-19 | 3 | Full range available |
     | 20 | 2 | 3 hours would exceed 22:00 |
     | 21 | 1 | 2 hours would exceed 22:00 |

   - EC-10: Multi-hour booking display in week view
     - Compact blocks with user initials (not full name)
     - Same color coding as day view

5. **Category: Week Transitions**
   - EC-11: Navigating from Sunday to next week
     - In week view, right arrow advances 7 days (next Monday)
     - In day view on Sunday, right arrow goes to Monday
   - EC-12: getStartOfWeek for Sunday
     - Sunday (day 0) maps to previous Monday (goes back 6 days)
     - Because: JavaScript getDay() returns 0 for Sunday, week starts Monday
   - EC-13: Week view shows today highlight
     - Current date should be visually distinguished in week view
   - EC-14: Switching from week view to day view
     - Clicking a day in week view switches to that specific date in day view
     - Clears any active selection (panel/popup)

6. **Category: Timezone Edge Cases**
   - EC-15: DST transition day
     - On the day DST starts/ends, toggle behavior changes
     - System uses real-time DST detection (not cached)
     - Because: DST changes at 2:00 AM or 3:00 AM; app may be open during transition
   - EC-16: NSW display shows hour beyond operating hours
     - 21:00 QLD = 22:00 NSW display during DST
     - This is display only -- no booking exists at 22:00
     - Users should understand displayed time differs from actual slot time
   - EC-17: Timezone doesn't affect booking data
     - Toggling to NSW does NOT change any stored booking times
     - API requests always use QLD time keys
     - Searching bookings uses QLD dateKey/timeKey regardless of toggle

7. **Category: Polling and Sync**
   - EC-18: Polling during booking creation
     - User creates booking at 09:00 (optimistic). Poll arrives with someone else's booking at 09:00.
     - Polling replaces entire state with server data
     - User's optimistic booking may be overwritten (if server rejected it)
     - No error shown to user (silent rollback)
   - EC-19: Network error during polling
     - Polling errors are non-fatal (logged to console only)
     - User continues working normally
     - Next poll attempt happens after interval (7 seconds)
   - EC-20: API failure during booking creation
     - Optimistic update shows booking immediately
     - API returns error (409 conflict, 500 server error)
     - triggerSync called immediately (doesn't wait for next poll)
     - Server truth replaces local state, effectively rolling back
   - EC-21: Rapid successive operations
     - User creates booking, immediately deletes another, changes duration of third
     - Each operation is independent optimistic update
     - API calls queued/parallel (no explicit ordering)
     - Polling eventually reconciles to server truth

8. **Category: Configuration**
   - EC-22: API unavailable at startup
     - Fallback config loaded (hardcoded CPS Software config with 6 users)
     - No error modal shown to user
     - Console warning logged
     - App fully functional with localStorage fallback for bookings
   - EC-23: Dynamic keyboard shortcuts from config
     - User hotkeys come from config (e.g., Jack -> "j", Bonnie -> "b")
     - If user added/removed from config, hotkeys change on next config load
     - Hotkeys are case-insensitive
   - EC-24: More than 6 users in config
     - Color assignment: first 6 users get unique colors (user-1 through user-6)
     - 7th+ users get user-6 color (no cycling, caps at last color)
     - Not an error condition -- just visual limitation

9. **Category: Keyboard Navigation**
   - EC-25: Arrow keys skip booked/blocked slots
     - Up/Down arrows only focus available slots
     - Wraps around: Up at first slot goes to last, Down at last goes to first
   - EC-26: Keyboard navigation in week view
     - Arrow keys disabled for slot navigation (no focusedSlotIndex in week view)
     - Left/Right still navigate dates (by 7 days)
   - EC-27: Typing in input fields
     - All keyboard shortcuts disabled when focus is in input/textarea
     - Prevents accidental shortcut activation during text entry
   - EC-28: Popup keyboard trap
     - When booking popup is open, ONLY popup shortcuts work (ESC, Enter, D, user keys, duration keys)
     - Navigation shortcuts (W, B, T, arrows) are completely disabled
     - Because: Prevents accidentally navigating away while editing a booking

10. **Category: Data Integrity**
    - EC-29: Empty date cleanup on delete
      - When last booking on a date is deleted, the date key is removed from storage
      - Prevents storage bloat with empty date objects
    - EC-30: Invalid booking data from server
      - If polling returns unexpected data format, it's silently ignored
      - Because: Defensive handling prevents UI crash from malformed data
    - EC-31: Booking for date that doesn't exist in local view
      - Bookings exist for dates not currently visible (past dates, future dates)
      - System stores all bookings, only displays relevant ones
      - No cleanup of old bookings (handled server-side if needed)

**Writing rules:**
- Each edge case has: What Happens, Expected Behavior, Why This Works (and optionally Warning Signs)
- Use Given-When-Then format for at least the most critical edge cases
- Include concrete data examples (times, dates, user names)
- Cross-reference to other spec docs where relevant
- Minimum 300 lines
  </action>
  <verify>
Verify EDGE-CASES.md:
- File exists with 300+ lines
- Contains numbered edge cases (EC-01 through EC-25+)
- Contains categories: Booking Conflicts, Past Hours, Multi-Hour Bookings, Week Transitions, Timezone, Polling and Sync, Configuration, Keyboard Navigation, Data Integrity
- Each edge case has "Expected Behavior" documented (not vague "handle gracefully")
- Contains concrete examples with times, dates, user names
- Cross-references other Phase 9 docs (BOOKING-FLOW, BOOK-NOW-FEATURE, TIMEZONE-TOGGLE, TIME-DATE-HANDLING)
- No React terminology in main content
  </verify>
  <done>
EDGE-CASES.md exists as a comprehensive catalog of 25+ edge cases organized by category, each with concrete expected behavior, covering booking conflicts, past hours, multi-hour bookings, week transitions, timezone, polling/sync, configuration, keyboard navigation, and data integrity.
  </done>
</task>

</tasks>

<verification>
1. Both files exist: `ls -la .planning/phases/09-functional-documentation/TIME-DATE-HANDLING.md .planning/phases/09-functional-documentation/EDGE-CASES.md`
2. Line counts: `wc -l` on both (TIME-DATE-HANDLING 200+, EDGE-CASES 300+)
3. Edge case numbering: grep for "EC-" in EDGE-CASES.md (expect 25+)
4. Categories in EDGE-CASES.md: grep for "Category:" (expect 8+)
5. No vague language: grep for "gracefully\|appropriately\|as expected\|handle errors" (should be 0)
6. Cross-references: grep for "BOOKING-FLOW\|BOOK-NOW\|TIMEZONE-TOGGLE\|TIME-DATE-HANDLING" in EDGE-CASES.md
7. Slot logic in TIME-DATE-HANDLING.md: grep for "isSlotPast\|isSlotBlocked\|generateTimeSlots\|START_HOUR\|END_HOUR"
8. No React terms in main content
</verification>

<success_criteria>
- TIME-DATE-HANDLING.md is the definitive reference for all time/date logic in the system
- EDGE-CASES.md covers every boundary condition with concrete expected behavior
- No "handle gracefully" or vague outcomes -- every edge case has specific behavior
- Edge cases organized by category for easy implementer reference
- Cross-references tie all 5 functional docs together into a cohesive specification
- Complete Phase 9: All 5 FUNC requirements satisfied across the 5 output documents
</success_criteria>

<output>
After completion, create `.planning/phases/09-functional-documentation/09-03-SUMMARY.md`
</output>
