---
phase: 09-functional-documentation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/09-functional-documentation/BOOK-NOW-FEATURE.md
  - .planning/phases/09-functional-documentation/TIMEZONE-TOGGLE.md
autonomous: true

must_haves:
  truths:
    - "Book Now button visibility conditions documented as exhaustive decision table"
    - "Book Now interaction flow documented from button click to booking panel open"
    - "Timezone toggle DST detection logic documented with IANA timezone references"
    - "Display conversion rules documented showing QLD-to-NSW hour offset"
    - "Timezone preference persistence documented"
  artifacts:
    - path: ".planning/phases/09-functional-documentation/BOOK-NOW-FEATURE.md"
      provides: "Book Now feature specification"
      min_lines: 150
      contains: "Visibility"
    - path: ".planning/phases/09-functional-documentation/TIMEZONE-TOGGLE.md"
      provides: "Timezone toggle specification"
      min_lines: 150
      contains: "DST"
  key_links:
    - from: "BOOK-NOW-FEATURE.md"
      to: "BOOKING-FLOW.md"
      via: "Reuses booking panel flow"
      pattern: "booking panel|BOOKING-FLOW"
    - from: "TIMEZONE-TOGGLE.md"
      to: "DATA-STORAGE.md"
      via: "Storage timezone reference"
      pattern: "Queensland|QLD|AEST|storage"
---

<objective>
Create BOOK-NOW-FEATURE.md and TIMEZONE-TOGGLE.md as focused functional specifications for these two independent features.

Purpose: FUNC-02 (Book Now) and FUNC-03 (Timezone Toggle) are self-contained features that each need complete behavioral documentation. Book Now is a convenience feature with specific visibility rules. Timezone Toggle is a display-only feature with DST detection logic.

Output:
- .planning/phases/09-functional-documentation/BOOK-NOW-FEATURE.md
- .planning/phases/09-functional-documentation/TIMEZONE-TOGGLE.md
</objective>

<execution_context>
@/Users/clintonweekes/.claude/get-shit-done/workflows/execute-plan.md
@/Users/clintonweekes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-functional-documentation/09-RESEARCH.md
@.planning/phases/06-code-extraction/FILE-MANIFEST.md
@.planning/phases/08-architecture-documentation/DATA-STORAGE.md
@.planning/phases/06-code-extraction/extracted-code/src/App.jsx
@.planning/phases/06-code-extraction/extracted-code/src/utils/time.js
@.planning/phases/06-code-extraction/extracted-code/src/utils/storage.js
@.planning/phases/06-code-extraction/extracted-code/src/components/Header.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BOOK-NOW-FEATURE.md (FUNC-02)</name>
  <files>.planning/phases/09-functional-documentation/BOOK-NOW-FEATURE.md</files>
  <action>
Create a focused functional specification for the Book Now feature. Read App.jsx (lines 74-94 for currentHourAvailable, lines 136-146 for handleBookNow) and Header.jsx for the visual representation.

**Document structure:**

1. **Feature Overview**
   - Purpose: One-click booking for the current hour (fastest path to book "right now")
   - Location: Header bar, next to navigation controls
   - Keyboard shortcut: [B] key
   - Visual: Pulsing animation to draw attention when visible

2. **Visibility Decision Table** (exhaustive truth table):
   All inputs that determine if Book Now button is shown:
   - Is current hour within operating hours (6 AM - 10 PM)?
   - Is current hour slot past? (uses isSlotPast: hour is past only when NEXT hour begins)
   - Is current hour slot available? (not booked, not blocked by multi-hour)

   | Current Hour in Range (6-21) | Slot Past? | Slot Status | Button Visible | Reason |
   | Yes | No | available | YES (pulsing) | User can book right now |
   | Yes | No | booked | NO | Already booked by someone |
   | Yes | No | blocked | NO | Blocked by multi-hour booking starting earlier |
   | Yes | Yes | any | NO | Hour has ended |
   | No (before 6 AM) | - | - | NO | Outside operating hours |
   | No (after 9 PM) | - | - | NO | Outside operating hours |

   Document the "current hour" edge case: At 9:45 AM, the 9:00 AM slot is still available and Book Now appears. At 10:00 AM, the 9:00 AM slot becomes past and Book Now re-evaluates for the 10:00 AM slot.

3. **Interaction Flow** (step-by-step):
   - Step 1: User clicks Book Now button OR presses [B] key
   - Step 2: System constructs a slot object for the current hour:
     - hour: current hour number
     - time: formatted display time
     - key: HH:00 format for storage
     - dateKey: today's date in YYYY-MM-DD
   - Step 3: System switches to today's date (if viewing a different date)
   - Step 4: Booking panel opens with the current hour pre-selected
   - Step 5: Standard booking flow continues (user selection -> duration selection -> create)
   - Note: Book Now does NOT auto-select a user or duration -- it just opens the panel faster

4. **Recalculation Triggers**:
   - Document when the button visibility recalculates:
     - On every booking state change (new booking, deleted booking via polling)
     - On hourly refresh (useHourlyRefresh triggers re-evaluation)
     - NOT on every second -- no continuous polling for button state

5. **Edge Cases with Given-When-Then**:
   - Book Now at 9:59 AM (still available)
   - Book Now at 10:00 AM (9 AM becomes past, 10 AM evaluated)
   - Book Now when someone else books current hour via polling (disappears)
   - Book Now when multi-hour booking blocks current hour (hidden)
   - Book Now outside operating hours (hidden)
   - Book Now when popup is open (B key disabled due to keyboard trap)
   - Book Now when viewing different date (switches to today)

6. **Visual Specification** (cross-reference to UI docs):
   - Pulsing animation (scale 1.0 to 1.05, 2s infinite cycle)
   - Hotkey indicator [B] shown on button
   - Button hidden entirely (not disabled) when unavailable

7. **Cross-References**:
   - BOOKING-FLOW.md for the booking panel flow that follows Book Now
   - STATE-MANAGEMENT.md for recalculation triggers
   - ANIMATIONS.md (Phase 7) for pulse animation specification

**Writing rules:**
- Technology-neutral: "System evaluates" not "useMemo recalculates"
- Include "Because" for non-obvious rules
- Minimum 150 lines
  </action>
  <verify>
Verify BOOK-NOW-FEATURE.md:
- File exists with 150+ lines
- Contains visibility decision table with all condition combinations
- Contains "Interaction Flow" section with step-by-step
- Contains at least 5 Given-When-Then edge case scenarios
- Contains recalculation triggers section
- No React terminology (no useMemo, useState, useCallback)
  </verify>
  <done>
BOOK-NOW-FEATURE.md exists with exhaustive visibility decision table, interaction flow, recalculation triggers, and edge case scenarios for the Book Now feature.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TIMEZONE-TOGGLE.md (FUNC-03)</name>
  <files>.planning/phases/09-functional-documentation/TIMEZONE-TOGGLE.md</files>
  <action>
Create a focused functional specification for the timezone toggle feature. Read App.jsx (lines 37, 67-69, 116-118), time.js (lines 30-41 for formatHour, lines 154-170 for DST detection), and storage.js for persistence.

**Document structure:**

1. **Feature Overview**
   - Purpose: NSW-based users can see booking times in their local timezone
   - Design principle: Display-only toggle -- all stored data remains in QLD time
   - Location: Header bar
   - Keyboard shortcut: [T] key
   - Why this exists: Business operates in QLD (no DST). NSW staff (who observe DST) need to mentally convert. Toggle eliminates this mental math during DST months.

2. **Timezone Context** (essential background):
   - Queensland (Australia/Brisbane): AEST, UTC+10, NO daylight saving time ever
   - NSW (Australia/Sydney): AEST normally (UTC+10), AEDT during DST (UTC+11)
   - DST period: First Sunday in October to first Sunday in April (approximately)
   - During DST: NSW is 1 hour ahead of QLD
   - Outside DST: NSW and QLD are the same time
   - IANA timezone names: Australia/Brisbane (QLD), Australia/Sydney (NSW)

3. **DST Detection Logic**:
   - How to detect: Format current time using Intl.DateTimeFormat with timezone 'Australia/Sydney'
   - Extract timezone name abbreviation from formatted parts
   - If abbreviation is "AEDT" -> DST is active -> offset = +1 hour
   - If abbreviation is "AEST" -> DST is not active -> offset = +0 hours
   - Because: Using the Intl API with IANA timezone name delegates DST rule changes to the platform. No hardcoded DST dates that could become wrong when legislation changes.
   - Decision table:

   | Timezone Abbreviation | DST Active? | Offset | Display Label |
   | AEDT | Yes | +1h | "NSW +1h" |
   | AEST | No | +0h | "NSW +0h" |

4. **Display Conversion Rules**:
   - When QLD mode (default): Display hours as-is from storage
   - When NSW mode AND DST active: Add 1 to display hour
   - When NSW mode AND DST not active: Display hours as-is (same as QLD)
   - Conversion examples:

   | Stored Hour (QLD) | QLD Display | NSW Display (DST) | NSW Display (no DST) |
   | 6 | 6:00 AM | 7:00 AM | 6:00 AM |
   | 12 | 12:00 PM | 1:00 PM | 12:00 PM |
   | 21 | 9:00 PM | 10:00 PM | 9:00 PM |

   - Because: Storage is always QLD time. The toggle changes what the USER sees, not what the SYSTEM stores.
   - Edge case: 21:00 QLD displays as 10:00 PM NSW during DST. This is display-only -- no bookings exist at 22:00.

5. **Affected Display Elements**:
   - Time slot labels in day view (every slot's time label)
   - Time slot labels in week view (every slot's time label)
   - Booking panel slot time display
   - Header timezone indicator label
   - NOT affected: dateKey, timeKey, API requests, stored data (all remain QLD)

6. **Toggle Interaction**:
   - Click toggle button in header OR press [T] key
   - Immediate switch (no animation, no API call)
   - Toggle shows: "QLD" or "NSW" with offset label
   - Offset label: "+1h" during DST, "+0h" outside DST

7. **Preference Persistence**:
   - Storage key: "cps-timezone-preference"
   - Stored value: "NSW" or "QLD" string
   - Storage mechanism: Browser local storage
   - Load on app initialization (before first render)
   - Save immediately on toggle
   - Default: QLD (false) if not set or on read error
   - Error handling: Silent failure on save, graceful fallback on read
   - Because: NSW users shouldn't have to re-toggle every time they open the app

8. **Edge Cases with Given-When-Then**:
   - Toggle during DST (times shift +1h)
   - Toggle outside DST (no change visible, but label shows "+0h")
   - Toggle while viewing week view (all 7 days update)
   - Preference persists after browser refresh
   - localStorage disabled (graceful fallback to QLD)
   - DST transition day (toggle behavior before/after midnight)
   - Book Now button with NSW toggle (Book Now uses QLD time internally)

9. **Implementation Constraints**:
   - DST detection must use IANA timezone names, not hardcoded dates
   - Display conversion is a simple +1 addition, not full timezone conversion
   - All API calls use QLD time regardless of toggle state
   - Timezone toggle has no server-side component

10. **Cross-References**:
    - DATA-STORAGE.md for QLD timezone storage rationale
    - time.js (extracted code) for implementation reference
    - COMPONENT-STATES.md (Phase 7) for toggle visual states

**Writing rules:**
- Technology-neutral: "System detects" not "Intl.DateTimeFormat returns"
- Include IANA timezone names (Australia/Brisbane, Australia/Sydney)
- Minimum 150 lines
  </action>
  <verify>
Verify TIMEZONE-TOGGLE.md:
- File exists with 150+ lines
- Contains DST detection logic with decision table
- Contains display conversion table with QLD/NSW examples
- Contains "Preference Persistence" section
- Contains at least 5 Given-When-Then scenarios
- References IANA timezone names (Australia/Brisbane, Australia/Sydney)
- Clearly states storage always uses QLD time
- No React terminology in main content
  </verify>
  <done>
TIMEZONE-TOGGLE.md exists with complete DST detection logic, display conversion rules, persistence specification, and edge cases for the timezone toggle feature.
  </done>
</task>

</tasks>

<verification>
1. Both files exist: `ls -la .planning/phases/09-functional-documentation/BOOK-NOW-FEATURE.md .planning/phases/09-functional-documentation/TIMEZONE-TOGGLE.md`
2. Line counts: `wc -l` on both files (expect 150+ each)
3. Decision tables present in both files
4. Given-When-Then scenarios in both files
5. No React terms: grep for useState/useCallback/useMemo/hooks in both files (should be 0 in main content)
6. IANA references in TIMEZONE-TOGGLE.md: grep for "Australia/Brisbane\|Australia/Sydney"
7. Visibility truth table in BOOK-NOW-FEATURE.md
8. DST detection logic in TIMEZONE-TOGGLE.md
</verification>

<success_criteria>
- BOOK-NOW-FEATURE.md completely specifies when the button appears and what happens when clicked
- TIMEZONE-TOGGLE.md completely specifies DST detection, display conversion, and preference persistence
- Both documents are self-contained (a Rails developer can implement each feature independently)
- Decision tables cover all condition combinations (no missing rows)
- Technology-neutral language throughout
</success_criteria>

<output>
After completion, create `.planning/phases/09-functional-documentation/09-02-SUMMARY.md`
</output>
