---
phase: 03-timezone-display
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/utils/time.js
  - src/utils/storage.js
  - src/App.jsx
  - src/components/Header.jsx
  - src/components/Header.css
  - src/components/TimeStrip.jsx
  - src/components/TimeSlot.jsx
  - src/components/WeekView.jsx
  - src/components/BookingPanel.jsx
autonomous: true

must_haves:
  truths:
    - "Toggle visible in header to switch between QLD and NSW time"
    - "When toggled to NSW, all displayed times show +1 hour during AEDT"
    - "When toggled to NSW, times show same as QLD during AEST (no offset)"
    - "Toggle shows current offset indicator (NSW +1h or NSW +0h)"
    - "Toggle state persists across browser sessions"
    - "All time displays update consistently when toggle is changed"
  artifacts:
    - path: "src/utils/time.js"
      provides: "isNSWInDST(), getNSWOffsetLabel(), formatHour() with timezone param"
      contains: "isNSWInDST"
    - path: "src/utils/storage.js"
      provides: "getTimezonePreference(), saveTimezonePreference()"
      contains: "TimezonePreference"
    - path: "src/App.jsx"
      provides: "useNSWTime state with localStorage persistence"
      contains: "useNSWTime"
    - path: "src/components/Header.jsx"
      provides: "Timezone toggle button with offset indicator"
      contains: "timezone-toggle"
  key_links:
    - from: "src/App.jsx"
      to: "src/utils/storage.js"
      via: "getTimezonePreference for initial state"
      pattern: "getTimezonePreference"
    - from: "src/App.jsx"
      to: "src/components/Header.jsx"
      via: "useNSWTime and onTimezoneToggle props"
      pattern: "useNSWTime.*onTimezoneToggle"
    - from: "src/components/TimeSlot.jsx"
      to: "src/utils/time.js"
      via: "formatHour with useNSWTime"
      pattern: "formatHour.*useNSWTime"
---

<objective>
Add timezone display toggle allowing users to view booking times in NSW timezone (AEDT/AEST) instead of Queensland (AEST only).

Purpose: Sydney/Melbourne users can view times in their local timezone while bookings remain stored in QLD time.

Output: Header toggle button that switches all time displays between QLD and NSW, with proper DST detection and localStorage persistence.
</objective>

<execution_context>
@/Users/clintonweekes/.claude/get-shit-done/workflows/execute-plan.md
@/Users/clintonweekes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-timezone-display/03-RESEARCH.md
@src/utils/time.js
@src/utils/storage.js
@src/App.jsx
@src/components/Header.jsx
@src/components/Header.css

**Phase 2 Context (IMPORTANT):**
Header.jsx was modified in Phase 2 to add "Book Now" button:
- Function signature: `({ title, currentDate, onNavigate, onWeekToggle, isWeekView, showBookNow, onBookNow })`
- `header-actions` div wrapper already exists with Book Now button and week-toggle inside
- CSS: `.header-actions` flex container, `.book-now-btn` styling, mobile breakpoint hiding `.week-toggle`
- The timezone toggle should be added AFTER the week-toggle button (third in the group)

**Research Key Findings:**
- QLD (AEST) is UTC+10 year-round, NSW has AEDT (UTC+11) in summer
- Use `Intl.DateTimeFormat` with 'Australia/Sydney' to detect DST (returns 'AEDT' or 'AEST')
- Display-only conversion: +1 hour during AEDT, +0 during AEST
- Bookings always stored in QLD time regardless of display setting
- Follow existing storage.js pattern for localStorage persistence
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add timezone utilities to time.js and storage.js</name>
  <files>src/utils/time.js, src/utils/storage.js</files>
  <action>
**In src/utils/time.js:**

1. Add `isNSWInDST()` function to detect if NSW is currently in daylight saving time:
```javascript
export function isNSWInDST() {
  const now = new Date();
  const formatter = new Intl.DateTimeFormat('en-AU', {
    timeZone: 'Australia/Sydney',
    timeZoneName: 'short'
  });
  const parts = formatter.formatToParts(now);
  const tzName = parts.find(part => part.type === 'timeZoneName')?.value;
  return tzName === 'AEDT';
}
```

2. Add `getNSWOffsetLabel()` function to get the current offset label:
```javascript
export function getNSWOffsetLabel() {
  return isNSWInDST() ? '+1h' : '+0h';
}
```

3. Modify the existing `formatHour(hour)` function to accept an optional `useNSWTime` parameter:
```javascript
export function formatHour(hour, useNSWTime = false) {
  let displayHour = hour;

  if (useNSWTime && isNSWInDST()) {
    displayHour = hour + 1;
  }

  const period = displayHour >= 12 ? 'PM' : 'AM';
  const h = displayHour > 12 ? displayHour - 12 : displayHour === 0 ? 12 : displayHour;
  return `${h}:00 ${period}`;
}
```

**In src/utils/storage.js:**

4. Add timezone preference storage functions following existing pattern:
```javascript
const TZ_PREFERENCE_KEY = 'cps-timezone-preference';

export function getTimezonePreference() {
  try {
    const value = localStorage.getItem(TZ_PREFERENCE_KEY);
    return value === 'NSW';
  } catch (error) {
    console.error('Error reading timezone preference:', error);
    return false; // Default to QLD
  }
}

export function saveTimezonePreference(useNSW) {
  try {
    localStorage.setItem(TZ_PREFERENCE_KEY, useNSW ? 'NSW' : 'QLD');
    return true;
  } catch (error) {
    console.error('Error saving timezone preference:', error);
    return false;
  }
}
```
  </action>
  <verify>
Run `npm run build` - no compilation errors. Grep for `isNSWInDST` in time.js and `TimezonePreference` in storage.js.
  </verify>
  <done>
time.js exports isNSWInDST, getNSWOffsetLabel, and formatHour accepts useNSWTime parameter. storage.js exports getTimezonePreference and saveTimezonePreference.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add timezone state management and header toggle</name>
  <files>src/App.jsx, src/components/Header.jsx, src/components/Header.css</files>
  <action>
**In src/App.jsx:**

1. Import new functions at the top:
```javascript
import { getTimezonePreference, saveTimezonePreference } from './utils/storage';
import { getNSWOffsetLabel } from './utils/time';
```

2. Add `useNSWTime` state with lazy initialization from localStorage (after `selectedBooking` state):
```javascript
const [useNSWTime, setUseNSWTime] = useState(() => getTimezonePreference());
```

3. Add useEffect to persist timezone changes to localStorage:
```javascript
useEffect(() => {
  saveTimezonePreference(useNSWTime);
}, [useNSWTime]);
```

4. Add `handleTimezoneToggle` callback:
```javascript
const handleTimezoneToggle = useCallback(() => {
  setUseNSWTime(prev => !prev);
}, []);
```

5. Pass new props to Header component:
```jsx
<Header
  ...existing props...
  useNSWTime={useNSWTime}
  onTimezoneToggle={handleTimezoneToggle}
/>
```

6. Pass `useNSWTime` to components that display times:
- TimeStrip: `useNSWTime={useNSWTime}`
- WeekView: `useNSWTime={useNSWTime}`
- BookingPanel: `useNSWTime={useNSWTime}`

**In src/components/Header.jsx:**

7. Import `getNSWOffsetLabel`:
```javascript
import { formatDisplayDate, isToday, getNSWOffsetLabel } from '../utils/time';
```

8. Update function signature to accept new props (note: `showBookNow, onBookNow` already exist from Phase 2):
```javascript
export function Header({ title, currentDate, onNavigate, onWeekToggle, isWeekView, showBookNow, onBookNow, useNSWTime, onTimezoneToggle })
```

9. Add timezone toggle button in header-actions div, AFTER the week-toggle button (note: Book Now button already exists before week-toggle from Phase 2):
```jsx
<button
  className={`timezone-toggle ${useNSWTime ? 'active' : ''}`}
  onClick={onTimezoneToggle}
  aria-pressed={useNSWTime}
  aria-label="Toggle timezone display"
>
  <span className="mono">[T]</span> {useNSWTime ? `NSW ${getNSWOffsetLabel()}` : 'QLD'}
</button>
```

**In src/components/Header.css:**

10. Add styling for timezone-toggle button, similar to week-toggle:
```css
.timezone-toggle {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 20px;
  background: transparent;
  border: 2px solid var(--accent);
  border-radius: 8px;
  font-size: 0.9rem;
  font-weight: 500;
  color: var(--accent);
  transition: all var(--transition-fast);
  box-shadow: 0 0 12px var(--accent-glow), inset 0 0 12px rgba(0, 229, 229, 0.1);
}

.timezone-toggle:hover {
  background: rgba(0, 229, 229, 0.1);
  box-shadow: 0 0 20px var(--accent-glow-strong), inset 0 0 20px rgba(0, 229, 229, 0.15);
}

.timezone-toggle.active {
  background: var(--accent);
  color: var(--bg-primary);
  box-shadow: 0 0 24px var(--accent-glow-strong);
}

.timezone-toggle .mono {
  opacity: 0.8;
  font-size: 0.8rem;
}
```

11. In mobile breakpoint (@media max-width: 600px), ADD timezone toggle styling (note: week-toggle is already hidden on mobile from Phase 2, keeping Book Now visible):
```css
/* Inside existing @media (max-width: 600px) block, ADD: */
.timezone-toggle {
  padding: 8px 12px;
  font-size: 0.8rem;
}
```
  </action>
  <verify>
Run `npm run dev` and open browser. Verify:
1. Timezone toggle button visible in header showing "QLD"
2. Clicking toggles to "NSW +1h" (or "+0h" if currently AEST)
3. Button styling matches week-toggle (cyberpunk neon style)
4. Refresh page - toggle state persists
  </verify>
  <done>
App.jsx has useNSWTime state with localStorage persistence. Header shows timezone toggle with offset indicator. Toggle persists across page refreshes.
  </done>
</task>

<task type="auto">
  <name>Task 3: Thread timezone through all time-displaying components</name>
  <files>src/components/TimeStrip.jsx, src/components/TimeSlot.jsx, src/components/WeekView.jsx, src/components/BookingPanel.jsx</files>
  <action>
**In src/components/TimeStrip.jsx:**

1. Add `useNSWTime` to props:
```javascript
export function TimeStrip({
  ...existing props...,
  useNSWTime = false,
})
```

2. Pass `useNSWTime` to TimeSlot:
```jsx
<TimeSlot
  ...existing props...
  useNSWTime={useNSWTime}
/>
```

**In src/components/TimeSlot.jsx:**

3. Import `formatHour`:
```javascript
import { isSlotPast, formatHour } from '../utils/time';
```

4. Add `useNSWTime` to props:
```javascript
export function TimeSlot({
  time,
  hour,
  ...other props...,
  useNSWTime = false,
})
```

5. Compute display time using formatHour with timezone:
```javascript
const displayTime = formatHour(hour, useNSWTime);
```

6. Update the time label to use `displayTime` instead of `time` prop:
```jsx
<span className="time-label mono">{displayTime}</span>
```

7. Update aria-label to use `displayTime`:
```javascript
aria-label={
  isPast
    ? `${displayTime} - Past`
    : isOccupied
    ? `${displayTime} - Occupied`
    : `${displayTime} - Available, click to book`
}
```

**In src/components/WeekView.jsx:**

8. Import `formatHour`:
```javascript
import { getWeekDays, getStartOfWeek, formatDate, formatShortDate, generateTimeSlots, isToday, isSlotPast, formatHour } from '../utils/time';
```

9. Add `useNSWTime` to props:
```javascript
export function WeekView({ ..., useNSWTime = false })
```

10. In the time column mapping, use formatHour with timezone:
```jsx
{TIME_SLOTS.map((slot) => (
  <div key={slot.key} className="time-cell mono">
    {formatHour(slot.hour, useNSWTime)}
  </div>
))}
```

11. Update `getSlotTitle` function to use timezone-aware time:
```javascript
const getSlotTitle = (date, slot) => {
  const dateKey = formatDate(date);
  const slotStatus = getSlotStatus(dateKey, slot.key, slot.hour);
  const displayTime = formatHour(slot.hour, useNSWTime);

  if (slotStatus.status === 'booked') {
    return `${displayTime}: ${slotStatus.booking.user} (${slotStatus.booking.duration}hr)`;
  }
  if (slotStatus.status === 'blocked') {
    return `${displayTime}: Blocked by ${slotStatus.booking?.user}`;
  }
  return `${displayTime}: Available`;
};
```

**In src/components/BookingPanel.jsx:**

12. Import `formatHour`:
```javascript
import { formatHour } from '../utils/time';
```

13. Add `useNSWTime` to props:
```javascript
export function BookingPanel({
  ...existing props...,
  useNSWTime = false,
})
```

14. Compute display time from slot hour:
```javascript
const displayTime = selectedSlot ? formatHour(selectedSlot.hour, useNSWTime) : '';
```

15. Update the panel-time span to use computed display time:
```jsx
<span className="panel-time mono">{displayTime}</span>
```
  </action>
  <verify>
Run `npm run dev` and open browser. Test the following:
1. Day view: Toggle timezone - all slot times update (+1h during AEDT or same during AEST)
2. Week view: Toggle timezone - time column and slot tooltips update
3. Click a slot to open BookingPanel - time shows in selected timezone
4. Navigate between dates - timezone stays consistent
5. Create a booking, then toggle timezone - verify booking key/time is unaffected (display only)
  </verify>
  <done>
All time-displaying components (TimeSlot, TimeStrip, WeekView, BookingPanel) receive and use useNSWTime prop. Toggling timezone updates all time displays consistently.
  </done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build` completes without errors
2. Toggle visible: Header shows "QLD" button (or "NSW +Xh" when active)
3. Toggle works: Clicking switches between QLD and NSW display
4. Offset correct: During AEDT shows "+1h", during AEST shows "+0h"
5. Persistence: Refresh page - toggle state is preserved
6. Day view: All time slots show timezone-adjusted times
7. Week view: Time column and tooltips show timezone-adjusted times
8. Booking panel: Selected slot time shows timezone-adjusted
9. Storage unchanged: Check localStorage - bookings still use QLD hours (06:00, 10:00, etc.)
10. DST detection: Use browser console to verify `isNSWInDST()` returns correct value
</verification>

<success_criteria>
- TIME-01: Toggle visible in header to switch between QLD and NSW time
- TIME-02: When toggled to NSW, all displayed times show +1 hour (during AEDT)
- TIME-03: Toggle shows current offset indicator ("NSW +1h" or "NSW +0h")
- TIME-04: Closing and reopening browser retains toggle preference
- Display-only: Bookings stored in QLD time regardless of display setting
- Consistent: All time displays update when toggle is changed
- No regressions: Existing booking functionality unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/03-timezone-display/03-01-SUMMARY.md`
</output>
