---
phase: 03-timezone-display
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/TimeStrip.jsx
  - src/components/BookingOverlay.jsx
  - src/components/BookingBlock.jsx
  - src/components/WeekView.jsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Booking time ranges update when timezone is toggled"
    - "Day view: booking card shows NSW times when toggle is active (e.g., 1-3 PM instead of 12-2 PM)"
    - "Week view: booking cell times update when toggle is active"
    - "No visual overlap or corruption in day view"
  artifacts:
    - path: "src/components/BookingBlock.jsx"
      provides: "Timezone-aware time display in booking cards"
      contains: "useNSWTime"
    - path: "src/components/BookingOverlay.jsx"
      provides: "Passes useNSWTime to BookingBlock"
      contains: "useNSWTime"
---

<objective>
Fix booking display to be timezone-aware and resolve visual overlap issues.

Issues found during manual testing:
1. Booking card time ranges (e.g., "Giuliano (12-2 PM)") don't update when timezone is toggled
2. Visual overlap/corruption in day view with booking slots

Root cause: useNSWTime prop is not threaded through to BookingOverlay → BookingBlock, and BookingBlock has its own non-timezone-aware formatTimeRange function.
</objective>

<context>
@src/components/TimeStrip.jsx - Passes useNSWTime to TimeSlot but NOT to BookingOverlay
@src/components/BookingOverlay.jsx - Maps bookings to BookingBlock, doesn't receive useNSWTime
@src/components/BookingBlock.jsx - Has its own formatShortHour/formatTimeRange (lines 10-30) that aren't timezone-aware
@src/components/WeekView.jsx - May need similar fix for week view booking cells
@src/utils/time.js - Has formatHour(hour, useNSWTime) that should be reused

**The fix pattern:**
1. Thread useNSWTime from TimeStrip → BookingOverlay → BookingBlock
2. Make BookingBlock use formatHour from time.js (with useNSWTime) instead of local formatShortHour
3. Update formatTimeRange to be timezone-aware
</context>

<tasks>

<task type="auto">
  <name>Task 1: Thread useNSWTime to BookingOverlay and BookingBlock</name>
  <files>src/components/TimeStrip.jsx, src/components/BookingOverlay.jsx, src/components/BookingBlock.jsx</files>
  <action>
**In src/components/TimeStrip.jsx:**

1. Pass useNSWTime to BookingOverlay:
```jsx
<BookingOverlay
  dayBookings={dayBookings}
  date={date}
  currentUser={currentUser}
  onCancel={handleOverlayCancel}
  onBookingClick={handleBookingClick}
  users={users}
  useNSWTime={useNSWTime}
/>
```

**In src/components/BookingOverlay.jsx:**

2. Add useNSWTime to props:
```javascript
export function BookingOverlay({
  dayBookings,
  date,
  currentUser,
  onCancel,
  onBookingClick,
  users = [],
  useNSWTime = false,
})
```

3. Pass useNSWTime to BookingBlock:
```jsx
<BookingBlock
  key={timeKey}
  booking={booking}
  startHour={startHour}
  date={date}
  currentUser={currentUser}
  onCancel={() => onCancel?.(timeKey)}
  onClick={() => onBookingClick?.(timeKey, booking)}
  users={users}
  useNSWTime={useNSWTime}
/>
```

**In src/components/BookingBlock.jsx:**

4. Add useNSWTime to props:
```javascript
export function BookingBlock({
  booking,
  startHour,
  date,
  currentUser,
  onCancel,
  onClick,
  users = [],
  useNSWTime = false,
})
```

5. Import formatHour from time.js at the top:
```javascript
import { isSlotPast, START_HOUR, formatHour, isNSWInDST } from '../utils/time';
```

6. Update formatShortHour to use timezone:
```javascript
function formatShortHour(hour, useNSWTime = false) {
  let displayHour = hour;
  if (useNSWTime && isNSWInDST()) {
    displayHour = hour + 1;
  }
  const period = displayHour >= 12 ? 'PM' : 'AM';
  const h = displayHour > 12 ? displayHour - 12 : displayHour === 0 ? 12 : displayHour;
  return `${h} ${period}`;
}
```

7. Update formatTimeRange to use timezone:
```javascript
function formatTimeRange(startHour, endHour, useNSWTime = false) {
  let startDisplay = startHour;
  let endDisplay = endHour;

  if (useNSWTime && isNSWInDST()) {
    startDisplay = startHour + 1;
    endDisplay = endHour + 1;
  }

  const startPeriod = startDisplay >= 12 ? 'PM' : 'AM';
  const endPeriod = endDisplay >= 12 ? 'PM' : 'AM';
  const startH = startDisplay > 12 ? startDisplay - 12 : startDisplay === 0 ? 12 : startDisplay;
  const endH = endDisplay > 12 ? endDisplay - 12 : endDisplay === 0 ? 12 : endDisplay;

  if (startPeriod === endPeriod) {
    return `${startH}-${endH} ${endPeriod}`;
  } else {
    return `${startH} ${startPeriod}-${endH} ${endPeriod}`;
  }
}
```

8. Update usages of formatTimeRange and formatShortHour in the component to pass useNSWTime:
- Line ~115: `formatTimeRange(displayStartHour, displayEndHour, useNSWTime)`
- Line ~127 aria-label: `formatShortHour(displayStartHour, useNSWTime)` and `formatShortHour(displayEndHour, useNSWTime)`
  </action>
  <verify>
Run `npm run dev`. In day view:
1. Create a booking
2. Toggle timezone to NSW
3. Verify booking card time range updates (e.g., 12-2 PM becomes 1-3 PM)
  </verify>
  <done>
BookingBlock receives useNSWTime and displays timezone-adjusted times in booking cards.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix WeekView booking cell times</name>
  <files>src/components/WeekView.jsx</files>
  <action>
Check how WeekView displays booking cell content. If it shows booking times in cells, update to use timezone-aware formatting.

Look for where booking info is rendered in the grid cells. The existing getSlotTitle function already uses formatHour with useNSWTime for tooltips, but check if cell content needs similar treatment.

If cells show times directly, update to use formatHour(hour, useNSWTime).
  </action>
  <verify>
In week view:
1. Create a booking visible in week view
2. Toggle timezone
3. Verify any time displays in cells update correctly
  </verify>
  <done>
WeekView booking cells display timezone-adjusted times.
  </done>
</task>

<task type="auto">
  <name>Task 3: Investigate and fix visual overlap in day view</name>
  <files>src/components/TimeSlot.jsx, src/components/BookingBlock.jsx, src/components/TimeStrip.css</files>
  <action>
Investigate the visual overlap issue seen in screenshot where slot labels and booking cards misalign.

**Potential causes to check:**
1. TimeSlot displays `displayTime` (NSW-adjusted) while BookingBlock position is based on QLD `startHour`
2. Both should use same hour reference for positioning
3. Check if there's text being duplicated (screenshot showed "Book 8:00 AM AM")

**Debug steps:**
1. Check what "Book 8:00 AM AM" is - seems like duplicate text somewhere
2. Look at TimeSlot.jsx line 65: `<span className="time-label mono">{displayTime}</span>`
3. Search for any place that combines "Book" with time

If the visual overlap is due to timezone mismatch between slot label and booking position:
- The booking block position should remain the same (it's positioned by QLD startHour, which matches the slot's actual position)
- Only the displayed time labels should change
- This should be cosmetically correct - block appears at right slot, time labels all show same offset

If there's a genuine overlap bug, document findings and fix.
  </action>
  <verify>
In day view with bookings:
1. Toggle timezone multiple times
2. Verify no visual corruption or text overlap
3. Booking blocks align with their correct slot positions
  </verify>
  <done>
Day view displays correctly with no visual overlap. Booking blocks and slot labels properly aligned.
  </done>
</task>

</tasks>

<verification>
1. Day view: Booking card "User (9-10 AM)" becomes "User (10-11 AM)" when NSW toggle active during AEDT
2. Week view: Booking tooltips/cells show adjusted times
3. No visual overlap or text corruption in day view
4. Booking blocks stay in correct slot positions (position unchanged, only display times change)
5. aria-labels include timezone-adjusted times for accessibility
</verification>

<success_criteria>
- Booking time ranges are timezone-aware throughout the app
- All time displays update consistently when toggle is changed
- No visual corruption or overlap issues
- Bookings remain stored in QLD time (only display changes)
</success_criteria>

<output>
After completion, create `.planning/phases/03-timezone-display/03-03-SUMMARY.md`
</output>
