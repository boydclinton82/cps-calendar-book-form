---
phase: 08-architecture-documentation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/08-architecture-documentation/API-CONTRACTS.md
autonomous: true

must_haves:
  truths:
    - "Every API endpoint is documented with method, path, request body, success response, and all error responses"
    - "Validation rules are documented for every input field with regex patterns and constraints"
    - "Conflict detection logic is documented for both create and update operations with concrete examples"
    - "Security layer is documented (CORS, rate limiting, input sanitization, security headers)"
    - "Error response formats are consistent and include all possible HTTP status codes per endpoint"
    - "Duration overlap scenarios are documented with step-by-step examples showing what passes and what fails"
  artifacts:
    - path: ".planning/phases/08-architecture-documentation/API-CONTRACTS.md"
      provides: "Complete API endpoint documentation with request/response formats and error handling"
      min_lines: 250
  key_links:
    - from: "API-CONTRACTS.md"
      to: "api/bookings/index.js"
      via: "Documents GET /api/bookings and POST /api/bookings"
      pattern: "GET /api/bookings|POST /api/bookings"
    - from: "API-CONTRACTS.md"
      to: "api/bookings/update.js"
      via: "Documents PUT /api/bookings/update and DELETE /api/bookings/update"
      pattern: "PUT /api/bookings/update|DELETE /api/bookings/update"
    - from: "API-CONTRACTS.md"
      to: "api/config.js"
      via: "Documents GET /api/config"
      pattern: "GET /api/config"
    - from: "API-CONTRACTS.md"
      to: "api/_lib/security.js"
      via: "Documents security middleware applied to all endpoints"
      pattern: "withSecurity|rate.limit|sanitize"
---

<objective>
Document all API endpoints with complete request/response formats, validation rules, error handling, and conflict detection logic as a single comprehensive API contracts reference.

Purpose: This is the most critical architecture document for Rails reimplementation. The API is the stable interface between frontend and backend. Rails must implement identical endpoints with identical behavior. Every request format, response shape, error code, and validation rule must be precisely documented.

Output: API-CONTRACTS.md in the phase directory covering ARCH-02 requirements.
</objective>

<execution_context>
@/Users/clintonweekes/.claude/get-shit-done/workflows/execute-plan.md
@/Users/clintonweekes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-architecture-documentation/08-RESEARCH.md

Source code (read ALL of these for exact implementation):
@api/config.js
@api/bookings/index.js
@api/bookings/update.js
@api/_lib/security.js

Phase 6 reference:
@.planning/phases/06-code-extraction/FILE-MANIFEST.md (API Endpoints section)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create API-CONTRACTS.md (ARCH-02)</name>
  <files>.planning/phases/08-architecture-documentation/API-CONTRACTS.md</files>
  <action>
Create a comprehensive API contracts document by reading ALL four API source files (api/config.js, api/bookings/index.js, api/bookings/update.js, api/_lib/security.js). Extract EXACT behavior from code, not approximations.

Document these sections:

**1. API Overview**
- Base URL: `/api` (relative, same origin)
- Content-Type: application/json for all requests and responses
- Authentication: None (public API)
- Security: All endpoints wrapped with withSecurity() middleware
- 5 operations across 3 endpoint paths

**2. Security Middleware (applies to ALL endpoints)**

Document the withSecurity() wrapper behavior:

a) Security Headers (set on every response):
   - X-Content-Type-Options: nosniff
   - X-Frame-Options: DENY
   - X-XSS-Protection: 1; mode=block
   - Referrer-Policy: strict-origin-when-cross-origin
   - Content-Security-Policy: default-src 'self'

b) CORS:
   - Allowed methods: GET, POST, PUT, DELETE, OPTIONS
   - Allowed headers: Content-Type, Authorization
   - Max-Age: 86400 (24 hours)
   - Allowed origins: localhost:5173, localhost:3000, *.vercel.app, plus permissive fallback (logs warning)
   - OPTIONS preflight returns 200 with CORS headers

c) Rate Limiting:
   - Window: 60 seconds (rolling)
   - Limit: 60 requests per minute per IP
   - IP detection: X-Forwarded-For (first entry) or X-Real-IP header
   - Storage: KV key `ratelimit:{ip}` with 120s TTL
   - Fail-open: if rate limit check errors, request is allowed
   - Response header: X-RateLimit-Remaining
   - Exceeded response: 429 `{ "error": "Too many requests. Please try again later." }`

d) Input Sanitization (sanitizeBookingInput):
   - dateKey: Must match `/^\d{4}-\d{2}-\d{2}$/` regex, null if no match
   - timeKey: Must match `/^\d{2}:00$/` regex, null if no match
   - user: HTML tags stripped, `<>'"` removed, trimmed, max 100 chars
   - duration: Parsed as integer, must be 1-8, null otherwise
   - updates.user: Same sanitization as user
   - updates.duration: Same validation as duration

**3. GET /api/config**

- Method: GET only (405 for other methods)
- Purpose: Return instance configuration
- Request: No body, no parameters
- Behavior:
  1. Read INSTANCE_SLUG from env (default: "cps-software")
  2. Construct KV key: `instance:{slug}:config`
  3. Fetch from KV
  4. If null, return hardcoded default (document exact default: slug, title, 6 users with name+key)
  5. Return config as JSON

- Success (200): Document exact response shape with example
- Error (500): `{ "error": "Failed to fetch configuration" }`
- Error (405): `{ "error": "Method not allowed" }`

**4. GET /api/bookings**

- Method: GET
- Purpose: Return all bookings for all dates
- Request: No body, no parameters
- Behavior:
  1. Read INSTANCE_SLUG, construct key `instance:{slug}:bookings`
  2. Fetch from KV
  3. If null, return empty object `{}`
  4. Return bookings as JSON

- Success (200): Nested bookings object (include multi-date, multi-booking example)
- Error (500): `{ "error": "Internal server error" }`

**5. POST /api/bookings**

- Method: POST
- Purpose: Create a new booking
- Request body: `{ dateKey, timeKey, user, duration }` (document each field with type, format, constraints)
- Behavior:
  1. Sanitize input via sanitizeBookingInput
  2. Validate: all 4 fields required and non-null after sanitization
  3. Fetch current bookings from KV
  4. Initialize date object if not exists
  5. Check if start slot already booked -> 409
  6. For multi-hour: check each subsequent slot (startHour+1 through startHour+duration-1) -> 409 with specific slot
  7. Create booking: `bookings[dateKey][timeKey] = { user, duration }`
  8. Save entire object back to KV
  9. Return 201 with success + booking

- Success (201): `{ success: true, booking: { dateKey, timeKey, user, duration } }`
- Error (400): `{ "error": "Missing or invalid fields: dateKey, timeKey, user, duration" }`
- Error (409): `{ "error": "Slot already booked" }` OR `{ "error": "Slot HH:00 conflicts with booking duration" }`
- Error (500): `{ "error": "Internal server error" }`

- Include CONCRETE conflict detection example:
  - Existing: 07:00 duration 2 (occupies 07:00, 08:00)
  - Attempt: 08:00 duration 1 -> 409 "Slot 08:00 conflicts with booking duration"
  - Attempt: 09:00 duration 1 -> 201 success

**6. PUT /api/bookings/update**

- Method: PUT
- Purpose: Update an existing booking (change user and/or duration)
- Request body: `{ dateKey, timeKey, updates: { user?, duration? } }`
- Behavior:
  1. Sanitize input
  2. Validate: dateKey, timeKey, updates required
  3. Fetch bookings, check booking exists at [dateKey][timeKey] -> 404 if not
  4. Duration change conflict check:
     - If duration unchanged or SHRINKING -> allow immediately (no conflict possible)
     - If duration INCREASING -> check ONLY new slots (from currentDuration to newDuration)
     - IMPORTANT: current booking's slots are excluded from conflict check
     - Example: Current at 07:00 dur=2 (occupies 07:00, 08:00). Extend to dur=3: ONLY check 09:00
  5. Merge updates into existing booking: `{ ...currentBooking, ...updates }`
  6. Save to KV
  7. Return 200

- Success (200): `{ success: true, booking: { user, duration } }` (merged booking)
- Error (400): `{ "error": "Missing or invalid fields: dateKey, timeKey, updates" }`
- Error (404): `{ "error": "Booking not found" }`
- Error (409): `{ "error": "Cannot extend: slot HH:00 is already booked" }`
- Error (500): `{ "error": "Internal server error" }`

**7. DELETE /api/bookings/update**

- Method: DELETE
- Path: /api/bookings/update (same path as PUT, differentiated by method)
- Purpose: Delete an existing booking
- Request body: `{ dateKey, timeKey }`
- Behavior:
  1. Sanitize input
  2. Validate: dateKey, timeKey required
  3. Fetch bookings, check booking exists -> 404 if not
  4. Delete: `delete bookings[dateKey][timeKey]`
  5. CLEANUP: if date has no remaining bookings, remove date key: `delete bookings[dateKey]`
  6. Save to KV

- Success (200): `{ success: true }`
- Error (400): `{ "error": "Missing or invalid fields: dateKey, timeKey" }`
- Error (404): `{ "error": "Booking not found" }`
- Error (500): `{ "error": "Internal server error" }`

**8. Edge Cases and Scenarios**

Document these specific scenarios with request/response examples:
a) Multi-hour booking at end of day (duration validation vs end hour)
b) Two users booking same slot simultaneously (first wins, second gets 409)
c) Extending duration into an occupied slot
d) Shrinking duration (always succeeds, no conflict check needed)
e) Changing user on existing booking (no validation, just replaces)
f) Deleting last booking for a date (date key cleaned up)
g) Request with HTML injection in user field (sanitized)

**9. Error Response Summary Table**

Create a table: Status Code | Meaning | When Returned | Example Response

Do NOT include React-specific terms. Do NOT document localStorage fallback (that is a frontend concern, not an API contract). Focus on the server API contract that Rails must implement identically.

Use OpenAPI-inspired markdown format as recommended by the research.
  </action>
  <verify>
Verify the document by checking:
1. File exists and has 250+ lines
2. All 5 operations documented (GET config, GET bookings, POST bookings, PUT bookings/update, DELETE bookings/update)
3. Every error response code has an example JSON body
4. Conflict detection documented with concrete examples for both create and update
5. Input sanitization regex patterns documented for dateKey and timeKey
6. Security headers, CORS, and rate limiting documented
7. No React-specific terminology (grep for useState, useEffect, localStorage, import.meta)
8. Edge cases section with concrete scenarios
  </verify>
  <done>API-CONTRACTS.md exists with all 5 API operations fully documented including request/response formats, every possible error response with example JSON, conflict detection logic with step-by-step examples, security middleware documentation, input validation with regex patterns, and edge case scenarios -- all technology-neutral and suitable for Rails reimplementation.</done>
</task>

</tasks>

<verification>
Phase-level checks for this plan:
1. API-CONTRACTS.md exists in .planning/phases/08-architecture-documentation/
2. All 5 API operations covered with method, path, request, response, errors
3. ARCH-02 requirements fully satisfied (all endpoints, request/response formats, error handling)
4. Conflict detection for create (POST) documents checking ALL slots in duration range
5. Conflict detection for update (PUT) documents checking ONLY new slots beyond current duration
6. Security middleware documented as cross-cutting concern
7. No React-specific terminology
</verification>

<success_criteria>
- API-CONTRACTS.md is a complete reference that a Rails developer could use to implement identical API endpoints
- Every request/response pair has concrete JSON examples
- Every error condition has the exact error message string
- Conflict detection logic is documented with worked examples showing pass/fail scenarios
- A Rails developer reading this document would never need to look at the React source code to understand the API contract
- ARCH-02 requirement fully satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/08-architecture-documentation/08-02-SUMMARY.md`
</output>
