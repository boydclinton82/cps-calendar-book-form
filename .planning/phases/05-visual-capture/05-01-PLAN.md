---
phase: 05-visual-capture
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/05-visual-capture/scripts/capture-all.mjs
  - .planning/phases/05-visual-capture/scripts/helpers.mjs
  - .planning/phases/05-visual-capture/screenshots/01-initial-states/
  - .planning/phases/05-visual-capture/screenshots/02-slot-states/
  - .planning/phases/05-visual-capture/screenshots/03-booking-flow/
  - .planning/phases/05-visual-capture/screenshots/04-book-now-button/
  - .planning/phases/05-visual-capture/screenshots/05-timezone-toggle/
  - .planning/phases/05-visual-capture/screenshots/06-responsive/
autonomous: true

must_haves:
  truths:
    - "Screenshot exists showing the empty calendar with no date selected (initial load)"
    - "Screenshot exists showing calendar with a date selected and full time slot grid visible"
    - "Screenshots exist for all five slot visual states: available, booked, past, current hour, blocked by multi-hour"
    - "Screenshots exist for every step of booking flow: panel open, name selected, duration selected, booking confirmed"
    - "Screenshots exist showing Book Now button when visible and the header when it is hidden"
    - "Screenshots exist showing QLD default timezone and NSW active with offset indicator"
    - "Screenshots exist at mobile (375px) and tablet (768px) breakpoints"
  artifacts:
    - path: ".planning/phases/05-visual-capture/scripts/helpers.mjs"
      provides: "Shared Playwright utilities: directory creation, wait helpers, screenshot naming"
    - path: ".planning/phases/05-visual-capture/scripts/capture-all.mjs"
      provides: "Main orchestration script that captures all VCAP-01 through VCAP-07 screenshots"
    - path: ".planning/phases/05-visual-capture/screenshots/"
      provides: "All raw screenshot PNG files organized by requirement category"
  key_links:
    - from: "scripts/capture-all.mjs"
      to: "https://booking-bmo-financial-solutions.vercel.app"
      via: "Playwright browser automation"
      pattern: "page\\.goto.*booking-bmo"
    - from: "scripts/capture-all.mjs"
      to: "screenshots/"
      via: "page.screenshot() calls with organized paths"
      pattern: "screenshot.*path.*screenshots/"
---

<objective>
Install Playwright and Sharp, then create and execute a comprehensive screenshot capture script that photographs every visual state of the deployed booking form.

Purpose: Capture the complete visual truth of the live app so the spec package has pixel-accurate reference images for Rails recreation. This is the foundation - raw screenshots that get annotated in Plan 02.

Output: 20-30 organized PNG screenshots covering all 7 VCAP requirements (VCAP-01 through VCAP-07), plus reusable capture scripts.
</objective>

<execution_context>
@/Users/clintonweekes/.claude/get-shit-done/workflows/execute-plan.md
@/Users/clintonweekes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-visual-capture/05-RESEARCH.md
@src/App.jsx
@src/components/Header.jsx
@src/components/TimeSlot.jsx
@src/components/TimeStrip.jsx
@src/components/BookingPanel.jsx
@src/components/BookingBlock.jsx
@src/components/BookingOverlay.jsx
@src/utils/time.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create helper utilities</name>
  <files>
    package.json
    .planning/phases/05-visual-capture/scripts/helpers.mjs
  </files>
  <action>
    1. Install Playwright and Sharp as dev dependencies:
       ```
       npm install --save-dev playwright sharp
       npx playwright install chromium
       ```
       Only install chromium browser (not all browsers) to save time/space.

    2. Create the screenshots output directory structure:
       ```
       .planning/phases/05-visual-capture/screenshots/
         01-initial-states/
         02-slot-states/
         03-booking-flow/
         04-book-now-button/
         05-timezone-toggle/
         06-responsive/
       ```

    3. Create `helpers.mjs` with shared utilities:
       - `ensureDirs(baseDir)` - creates all screenshot subdirectories
       - `waitForApp(page)` - navigates to `https://booking-bmo-financial-solutions.vercel.app`, waits for `networkidle` and `.app` selector to be visible (not the loading spinner)
       - `waitForAnimation(page, ms = 400)` - consistent animation wait
       - `screenshotPath(category, filename)` - builds absolute path like `screenshots/01-initial-states/001-empty-calendar.png`
       - `APP_URL` constant = `https://booking-bmo-financial-solutions.vercel.app`
       - `BREAKPOINTS` constant = `[{name: 'mobile', width: 375, height: 667}, {name: 'tablet', width: 768, height: 1024}, {name: 'desktop', width: 1440, height: 900}]`

    Keep helpers minimal. No annotation logic here (that's Plan 02).
  </action>
  <verify>
    - `node -e "import('playwright').then(() => console.log('playwright OK'))"` succeeds
    - `node -e "import('sharp').then(() => console.log('sharp OK'))"` succeeds
    - `ls .planning/phases/05-visual-capture/screenshots/` shows all 6 subdirectories
    - `node .planning/phases/05-visual-capture/scripts/helpers.mjs` imports without error
  </verify>
  <done>Playwright + Sharp installed, chromium browser downloaded, directory structure created, helpers.mjs exports all utility functions without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Create and execute the comprehensive capture script</name>
  <files>
    .planning/phases/05-visual-capture/scripts/capture-all.mjs
  </files>
  <action>
    Create `capture-all.mjs` that performs ALL captures in a single browser session. The script MUST be idempotent (re-runnable, overwrites existing screenshots).

    **IMPORTANT CONTEXT about the live app:**
    - URL: https://booking-bmo-financial-solutions.vercel.app
    - The app loads config from an API, showing a spinner first, then the calendar
    - CSS classes on slots: `.time-slot.available`, `.time-slot.past`, `.time-slot.occupied`
    - Booking blocks use `.booking-block` with user color classes
    - Header has `.book-now-btn`, `.timezone-toggle`, `.week-toggle`
    - BookingPanel uses `.booking-panel.open` with `.option-btn` for user/duration selection
    - Time slots are buttons inside `.slots-container` within `.time-strip`
    - Hours run from 6 AM (START_HOUR=6) to 10 PM (END_HOUR=22)
    - Today's view hides past slots (they don't render at all)
    - The app uses dark theme (dark background, light text)

    **Script structure - execute these capture groups sequentially:**

    **Group 1: VCAP-01 + VCAP-02 (Initial States)**
    - Launch chromium at 1440x900 viewport
    - Navigate to app, wait for load (`.time-strip` or `.app` visible, no `.spinner`)
    - Navigate to a FUTURE date (tomorrow or later) using the right arrow nav button (`.nav-btn`) so all 16 slots are visible (no past-slot filtering)
    - Screenshot the full page as `01-initial-states/001-empty-calendar-full-day.png` — this shows the calendar with a date that has all time slots visible but none selected for booking
    - For VCAP-01 specifically (no date context), capture the initial load state on page load BEFORE any navigation — take this screenshot first actually. Load the page, immediately screenshot as `01-initial-states/000-initial-load.png`
    - Then navigate forward to future date and capture `001-empty-calendar-full-day.png`
    - Click on an available time slot (one of the `.time-slot.available` buttons) to trigger the booking panel
    - Wait for `.booking-panel.open` to appear
    - Screenshot as `01-initial-states/002-date-selected-with-panel.png`
    - Press Escape or click cancel to close panel

    **Group 2: VCAP-03 (Slot States)**
    Navigate to the future date used above. Capture individual slot states:
    - `02-slot-states/001-slot-available.png` — screenshot of the time strip showing available slots (element screenshot of `.time-strip` or full page showing the slots clearly)
    - For booked and blocked states, we need to CREATE a booking via the UI:
      1. Click an available slot (e.g., the 10:00 AM slot)
      2. Wait for booking panel to open
      3. Click the first user option (`.option-btn` in the "Who?" section)
      4. Click a multi-hour duration (2h or 3h) from duration options to also demonstrate blocked slots
      5. Wait for booking to be confirmed (panel closes, booking block appears)
      6. Screenshot full page as `02-slot-states/002-slot-booked-and-blocked.png` — this shows the booked slot AND the subsequent blocked slots
    - For past slots: navigate to today's date. If there are past hours, the visible slots will already exclude them. Navigate to YESTERDAY using the left arrow — yesterday's view should show all slots as past (greyed out). Screenshot as `02-slot-states/003-slots-past.png`
    - For current hour: navigate back to today. The first visible slot should be the current hour (if within 6AM-10PM). Take an element-focused screenshot or full page as `02-slot-states/004-current-hour-slot.png`
    - Navigate back to the future date. The booking we created should still be visible showing the multi-hour block. Take a close crop of the booking block area: `02-slot-states/005-multi-hour-booking-block.png`

    **Group 3: VCAP-04 (Booking Flow)**
    Navigate to the future date. Find another available slot (different from the one already booked).
    - Step 1: Click the available slot. Wait for panel. Screenshot: `03-booking-flow/001-panel-open-slot-selected.png`
    - Step 2: Click a user name button. Screenshot: `03-booking-flow/002-user-selected.png`
    - Step 3: Click a duration (1h). Screenshot: `03-booking-flow/003-duration-selected.png` — actually, clicking duration CONFIRMS the booking and closes the panel. So capture the state JUST BEFORE clicking duration (user selected, duration buttons visible).
    - Step 4: Click the duration to confirm. Wait for panel to close and booking block to appear. Screenshot: `03-booking-flow/004-booking-confirmed.png`

    IMPORTANT: In this app, selecting duration IS the confirmation step. There is no separate confirm button. The flow is: click slot -> panel opens -> click user -> click duration -> booking created + panel closes. Capture the panel state after user selection (before duration click) and then the result after duration click.

    **Group 4: VCAP-05 (Book Now Button)**
    - Navigate to today's date. Check if `.book-now-btn` is visible.
    - If visible (current hour is available): screenshot header area showing the button as `04-book-now-button/001-book-now-visible.png`
    - If not visible (current hour is booked/past/outside hours): screenshot header as `04-book-now-button/002-book-now-hidden.png`, then note this.
    - To get BOTH states: If Book Now is visible, screenshot it, then book the current hour slot via UI (click Book Now, select user, select duration), then screenshot the header again without the button.
    - If Book Now is NOT visible (outside business hours or already booked), screenshot the hidden state, then try navigating to capture what you can. Document in console.log what was captured.
    - Handle gracefully: the script runs at any time of day. If outside 6AM-10PM, Book Now won't appear. Log this and take the hidden-state screenshot only.

    **Group 5: VCAP-06 (Timezone Toggle)**
    - Navigate to the future date (or stay on current). Ensure timezone toggle is visible in header.
    - Screenshot with QLD (default) active: `05-timezone-toggle/001-qld-default.png` — focus on header showing "QLD" in the toggle
    - Click `.timezone-toggle` button to switch to NSW
    - Wait for re-render (times change by +1h during DST)
    - Screenshot: `05-timezone-toggle/002-nsw-active.png` — header now shows "NSW +1h" (or "NSW +0h" outside DST)
    - Also capture the time slots to show the hour labels changed: `05-timezone-toggle/003-nsw-time-slots.png`
    - Toggle back to QLD for clean state

    **Group 6: VCAP-07 (Responsive)**
    Navigate to the future date. For each breakpoint in BREAKPOINTS:
    - Resize viewport to breakpoint dimensions
    - Wait for layout to settle (500ms)
    - Take full-page screenshot: `06-responsive/{breakpoint-name}-full-page.png`
    - If mobile (375px), also open the booking panel by clicking a slot, screenshot with panel: `06-responsive/mobile-with-panel.png`. The panel overlay (`.panel-overlay`) should be visible on mobile.

    **Cleanup:**
    - Close browser
    - Log summary: which screenshots were captured, any that were skipped and why
    - Exit with code 0 on success

    **Error handling:**
    - Wrap each group in try/catch so one failure doesn't stop all captures
    - Log errors clearly with group name
    - Continue to next group on failure
    - Exit with code 1 if any group failed, listing which ones

    **Run the script after creating it:**
    ```
    node .planning/phases/05-visual-capture/scripts/capture-all.mjs
    ```

    Examine the output. If any captures failed due to selector changes or timing issues, fix the script and re-run. The script should be adjusted based on what actually works with the live site. CSS class names and DOM structure may differ slightly from the source code if the build transforms them — inspect carefully and adapt.

    After successful capture, verify screenshots look correct by checking file sizes (should be >10KB each, <5MB each) and that files exist in all expected directories.
  </action>
  <verify>
    - `ls -la .planning/phases/05-visual-capture/screenshots/01-initial-states/` shows at least 2 PNG files
    - `ls -la .planning/phases/05-visual-capture/screenshots/02-slot-states/` shows at least 3 PNG files
    - `ls -la .planning/phases/05-visual-capture/screenshots/03-booking-flow/` shows at least 3 PNG files
    - `ls -la .planning/phases/05-visual-capture/screenshots/04-book-now-button/` shows at least 1 PNG file
    - `ls -la .planning/phases/05-visual-capture/screenshots/05-timezone-toggle/` shows at least 2 PNG files
    - `ls -la .planning/phases/05-visual-capture/screenshots/06-responsive/` shows at least 2 PNG files (mobile + tablet)
    - All PNG files are >10KB (not empty/corrupt) and <5MB (not bloated)
    - `node .planning/phases/05-visual-capture/scripts/capture-all.mjs` exits with code 0
  </verify>
  <done>All VCAP-01 through VCAP-07 raw screenshots captured and saved to organized directories. At minimum: 2 initial state images, 3+ slot state images, 3+ booking flow images, 1+ Book Now images, 2+ timezone images, 2+ responsive images. Script is idempotent and re-runnable.</done>
</task>

</tasks>

<verification>
1. Count total screenshots: `find .planning/phases/05-visual-capture/screenshots -name "*.png" | wc -l` should be >= 15
2. Check no empty files: `find .planning/phases/05-visual-capture/screenshots -name "*.png" -size 0` should return nothing
3. Check no oversized files: `find .planning/phases/05-visual-capture/screenshots -name "*.png" -size +5M` should return nothing
4. Re-run capture script to verify idempotency: `node .planning/phases/05-visual-capture/scripts/capture-all.mjs` succeeds again
5. Visually spot-check: open 2-3 screenshots to confirm they show the booking app (not blank pages or error screens)
</verification>

<success_criteria>
- Playwright and Sharp are installed as dev dependencies
- Capture script exists and runs successfully against the live deployed app
- Screenshots exist in all 6 category directories covering VCAP-01 through VCAP-07
- At least 15 distinct PNG screenshots captured
- Each screenshot is a valid image (>10KB, <5MB)
- Script handles edge cases (time-of-day, existing bookings) gracefully with logging
</success_criteria>

<output>
After completion, create `.planning/phases/05-visual-capture/05-01-SUMMARY.md`
</output>
