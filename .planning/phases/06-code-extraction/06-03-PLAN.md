---
phase: 06-code-extraction
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - .planning/phases/06-code-extraction/extracted-code/src/App.jsx
  - .planning/phases/06-code-extraction/extracted-code/src/hooks/useBookings.js
  - .planning/phases/06-code-extraction/extracted-code/src/hooks/useKeyboard.js
  - .planning/phases/06-code-extraction/extracted-code/src/hooks/usePollingSync.js
  - .planning/phases/06-code-extraction/extracted-code/src/utils/time.js
  - .planning/phases/06-code-extraction/extracted-code/src/utils/storage.js
  - .planning/phases/06-code-extraction/extracted-code/src/services/api.js
  - .planning/phases/06-code-extraction/extracted-code/api/bookings/index.js
  - .planning/phases/06-code-extraction/extracted-code/api/bookings/update.js
  - .planning/phases/06-code-extraction/extracted-code/api/_lib/security.js
  - .planning/phases/06-code-extraction/extracted-code/api/config.js
  - .planning/phases/06-code-extraction/ANNOTATIONS.md
autonomous: true

must_haves:
  truths:
    - "Key logic sections have technology-neutral annotations explaining WHAT and WHY"
    - "Annotations use standardized tags (BEHAVIOR, VALIDATION, EDGE_CASE, DATA_FLOW)"
    - "No React-specific jargon in annotations (no 'hook', 'props', 'state', 'useEffect')"
  artifacts:
    - path: ".planning/phases/06-code-extraction/ANNOTATIONS.md"
      provides: "Annotation legend and conventions"
      min_lines: 30
    - path: ".planning/phases/06-code-extraction/extracted-code/src/hooks/useBookings.js"
      provides: "Annotated booking logic"
      contains: "BEHAVIOR:"
    - path: ".planning/phases/06-code-extraction/extracted-code/src/utils/time.js"
      provides: "Annotated time utilities"
      contains: "EDGE_CASE:"
  key_links:
    - from: "ANNOTATIONS.md"
      to: "extracted-code/ annotated files"
      via: "tag definitions used in inline comments"
      pattern: "BEHAVIOR|VALIDATION|EDGE_CASE|DATA_FLOW"
---

<objective>
Add technology-neutral inline annotations to key logic files in the extracted code using standardized tags.

Purpose: CODE-03 requires that key logic sections explain WHAT and WHY in technology-neutral terms. The Rails Claude needs to understand business rules, validation logic, data flow, and edge cases without React knowledge.
Output: Annotated extracted code files + ANNOTATIONS.md legend.
</objective>

<execution_context>
@/Users/clintonweekes/.claude/get-shit-done/workflows/execute-plan.md
@/Users/clintonweekes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-code-extraction/06-RESEARCH.md
@.planning/phases/06-code-extraction/06-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create annotation legend and annotate core logic files</name>
  <files>
    .planning/phases/06-code-extraction/ANNOTATIONS.md
    .planning/phases/06-code-extraction/extracted-code/src/hooks/useBookings.js
    .planning/phases/06-code-extraction/extracted-code/src/hooks/useKeyboard.js
    .planning/phases/06-code-extraction/extracted-code/src/hooks/usePollingSync.js
    .planning/phases/06-code-extraction/extracted-code/src/utils/time.js
    .planning/phases/06-code-extraction/extracted-code/src/utils/storage.js
    .planning/phases/06-code-extraction/extracted-code/src/services/api.js
    .planning/phases/06-code-extraction/extracted-code/src/App.jsx
  </files>
  <action>
**Step 1: Create ANNOTATIONS.md legend**

Create `.planning/phases/06-code-extraction/ANNOTATIONS.md` with:

```markdown
# Annotation Conventions

## Purpose

Inline annotations in the extracted code use standardized tags to describe
business logic in technology-neutral terms. These annotations are written for
an AI (Claude Code) that will reimplement this system in Rails.

## Tags

| Tag | Use For | Example |
|-----|---------|---------|
| BEHAVIOR | Observable user-facing behavior | "Current hour slot stays available until :59" |
| VALIDATION | Input/output constraints and rules | "Duration cannot extend past END_HOUR (22)" |
| EDGE_CASE | Special handling for boundary conditions | "Midnight boundary: week rolls over at 00:00 Monday" |
| DATA_FLOW | How data moves between system parts | "Bookings fetched from API, cached locally, polled every 30s" |
| DATA_CONSTRAINT | Data format, range, or type requirements | "dateKey format: YYYY-MM-DD, always QLD timezone" |
| WHY | Rationale for a non-obvious design choice | "QLD timezone for storage: no DST means no ambiguous hours" |
| CONSTANT | System constant that affects behavior | "START_HOUR=6, END_HOUR=22, 16 one-hour slots per day" |

## Annotation Format

Single-line: `// TAG: description`
Multi-line:
/**
 * TAG: description
 * WHY: rationale
 * EDGE_CASE: boundary condition
 */

## Technology Translation Guide

| React Concept | Rails Equivalent | What Matters |
|---------------|------------------|--------------|
| useState | Instance variable or model attribute | What data is tracked |
| useEffect (on mount) | Controller action / after_initialize | When initialization runs |
| useEffect (on change) | Observer / callback | What triggers recomputation |
| useCallback | Method definition | What the function does |
| Context provider | Application config / helper | What config is shared |
| Component | View partial / Stimulus controller | What UI is rendered |
| Polling interval | ActionCable / Turbo Streams / cron | How real-time sync works |
```

**Step 2: Annotate core logic files**

Read each file from extracted-code/ and add inline annotations. Do NOT change any code logic, only add comments.

**Priority annotation targets (annotate thoroughly):**

1. **src/hooks/useBookings.js** (highest priority — core business logic):
   - BEHAVIOR for each function: getSlotStatus, canBook, createBooking, deleteBooking
   - VALIDATION for booking rules (duration limits, past-slot checks, conflict detection)
   - EDGE_CASE for multi-hour booking overlap, same-slot double booking
   - DATA_FLOW for how bookings are loaded, cached, and persisted
   - DATA_CONSTRAINT for booking object shape and field types

2. **src/utils/time.js** (critical for Rails recreation):
   - BEHAVIOR for each time function
   - CONSTANT for START_HOUR, END_HOUR, TIME_SLOTS
   - EDGE_CASE for current-hour-stays-available logic (isSlotPast)
   - DATA_CONSTRAINT for date/time key formats
   - WHY for Queensland timezone choice

3. **src/hooks/useKeyboard.js** (unique interaction model):
   - BEHAVIOR for each hotkey ([B] Book Now, [T] Timezone, [J]/[C]/etc user selection, [1-8] duration)
   - VALIDATION for when hotkeys are active vs disabled
   - EDGE_CASE for hotkey conflicts, panel open/closed states

4. **src/services/api.js** (API client contract):
   - DATA_FLOW for each API call (what endpoint, what data, what response)
   - VALIDATION for error handling patterns
   - EDGE_CASE for network failures, conflict responses

5. **src/App.jsx** (orchestrator):
   - BEHAVIOR for major state transitions (date selection, slot click, booking flow)
   - DATA_FLOW for how state flows from App to child components
   - EDGE_CASE for Book Now visibility logic

6. **src/hooks/usePollingSync.js**:
   - BEHAVIOR for polling interval and trigger conditions
   - DATA_FLOW for how polled data merges with local state
   - EDGE_CASE for conflict detection

7. **src/utils/storage.js**:
   - DATA_FLOW for storage interface (abstract getBookings/saveBooking)
   - WHY for the abstraction layer (Vercel KV is environment-specific)

**Annotation density guidelines:**
- Every exported function: at minimum a BEHAVIOR tag
- Every validation check: VALIDATION tag
- Every conditional branch that handles a boundary: EDGE_CASE tag
- Every fetch/save/transform: DATA_FLOW tag
- Constants with business meaning: CONSTANT tag

**CRITICAL: Avoid React-specific language in annotations.**
- Do NOT say "this hook manages state" — say "this module tracks booking data"
- Do NOT say "useEffect runs on mount" — say "on initialization, fetch bookings from server"
- Do NOT say "props.onBook callback" — say "booking confirmation triggers save to server"
- Do NOT say "re-render" — say "UI updates when data changes"
  </action>
  <verify>
- ANNOTATIONS.md exists with tag definitions and translation guide
- `grep -c "BEHAVIOR:" .planning/phases/06-code-extraction/extracted-code/src/hooks/useBookings.js` returns 3+
- `grep -c "EDGE_CASE:" .planning/phases/06-code-extraction/extracted-code/src/utils/time.js` returns 2+
- `grep -c "BEHAVIOR:" .planning/phases/06-code-extraction/extracted-code/src/hooks/useKeyboard.js` returns 3+
- No React jargon in annotations: `grep -i "useEffect\|useState\|props\.\|re-render\|this hook" .planning/phases/06-code-extraction/extracted-code/src/hooks/useBookings.js` returns 0 matches in comment lines (code lines will still have React syntax — that's fine)
  </verify>
  <done>ANNOTATIONS.md legend created. Core logic files (useBookings, time, useKeyboard, api, App, usePollingSync, storage) annotated with standardized tags. No React jargon in annotations.</done>
</task>

<task type="auto">
  <name>Task 2: Annotate API endpoint files</name>
  <files>
    .planning/phases/06-code-extraction/extracted-code/api/bookings/index.js
    .planning/phases/06-code-extraction/extracted-code/api/bookings/update.js
    .planning/phases/06-code-extraction/extracted-code/api/_lib/security.js
    .planning/phases/06-code-extraction/extracted-code/api/config.js
  </files>
  <action>
Read each API file from extracted-code/api/ and add inline annotations. Do NOT change any code logic.

**api/bookings/index.js:**
- BEHAVIOR: What GET and POST do (fetch bookings for a date, create a booking)
- DATA_FLOW: Request params -> validation -> KV lookup/write -> response
- VALIDATION: Required fields, format constraints
- DATA_CONSTRAINT: Key format in Vercel KV, response shape
- Add request/response examples as comments:
```
// REQUEST: GET /api/bookings?date=2026-02-13
// RESPONSE: { "09:00": { user: "Clinton", duration: 2, createdAt: "..." }, ... }
//
// REQUEST: POST /api/bookings
// BODY: { date: "2026-02-13", time: "09:00", user: "Clinton", duration: 2 }
// RESPONSE: 200 { success: true }
```

**api/bookings/update.js:**
- BEHAVIOR: What PUT/DELETE do (update booking, delete booking)
- VALIDATION: Must include date+time, user must match existing booking for delete
- EDGE_CASE: Concurrent modification handling (if any)

**api/_lib/security.js:**
- BEHAVIOR: What security checks are performed on each request
- VALIDATION: Rate limiting rules, origin checking, CORS
- WHY: Why these specific security measures exist

**api/config.js:**
- BEHAVIOR: Returns instance configuration
- DATA_CONSTRAINT: Config shape (users, instance name, colors, etc.)
- WHY: Per-instance configuration allows one codebase to serve multiple deployments

**Annotation style for API files should emphasize the CONTRACT:**
- What the endpoint expects (method, params, body)
- What the endpoint returns (status, body shape)
- What can go wrong (error codes, validation failures)
- This is what the Rails controller needs to replicate
  </action>
  <verify>
- All 4 API files have annotations
- `grep -c "BEHAVIOR:\|VALIDATION:\|DATA_FLOW:" .planning/phases/06-code-extraction/extracted-code/api/bookings/index.js` returns 3+
- Request/response examples present in bookings/index.js comments
- `grep -c "BEHAVIOR:" .planning/phases/06-code-extraction/extracted-code/api/_lib/security.js` returns 1+
  </verify>
  <done>All API endpoint files annotated with technology-neutral tags. Request/response contracts documented inline. Security and config endpoints annotated.</done>
</task>

</tasks>

<verification>
1. ANNOTATIONS.md exists with complete tag legend and translation guide
2. All 7 core logic files have inline annotations using standardized tags
3. All 4 API files have inline annotations with request/response examples
4. No React-specific jargon appears in annotation comments (code lines still have React syntax)
5. Every exported function has at minimum a BEHAVIOR annotation
6. Spot-check: Read annotations in useBookings.js — a Rails developer should understand the booking system without React knowledge
</verification>

<success_criteria>
- 11 files annotated with technology-neutral inline comments
- ANNOTATIONS.md provides legend and React-to-Rails translation guide
- Annotations explain WHAT (behavior) and WHY (rationale), not HOW (React implementation)
- No React jargon (hook, props, state, useEffect, re-render) in annotation text
- Edge cases explicitly called out in code comments
</success_criteria>

<output>
After completion, create `.planning/phases/06-code-extraction/06-03-SUMMARY.md`
</output>
